<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè³‡ç”¢è¦–è¦ºåŒ–å„€è¡¨æ¿</title>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <!-- å¼•å…¥ ChartDataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- å¼•å…¥ Chart.js Treemap Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <!-- å¼•å…¥ CountUp.js (æ•¸å­—æ²å‹•ç‰¹æ•ˆ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.min.js"></script>
    <!-- å¼•å…¥ Google Fonts: Noto Sans TC (å…§æ–‡) + Roboto Mono (æ•¸å­—) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* æ·±è‰²èƒŒæ™¯æ¼¸å±¤ï¼šç‡Ÿé€ æ·±é‚ƒæ„Ÿ */
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);

            /* æ¯›ç»ç’ƒå¡ç‰‡èƒŒæ™¯ */
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);

            /* æ–‡å­—ç³»çµ± */
            --text-main: #f8fafc;
            /* ä¸»è¦æ–‡å­— (äº®ç™½) */
            --text-secondary: #94a3b8;
            /* æ¬¡è¦æ–‡å­— (ç°è—) - å°æ‡‰èˆŠç‰ˆè®Šæ•¸å */

            /* æ•¸æ“šè‰²å½© */
            --accent-color: #38bdf8;
            /* å¼·èª¿è‰² (å¤©ç©ºè—) - å°æ‡‰èˆŠç‰ˆè®Šæ•¸å */
            --success-color: #34d399;
            /* ç²åˆ© (è–„è·ç¶ ) - å°æ‡‰èˆŠç‰ˆè®Šæ•¸å */
            --danger-color: #f87171;
            /* è™§æ (æŸ”å’Œç´…) - å°æ‡‰èˆŠç‰ˆè®Šæ•¸å */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-main);
            padding: 20px;
            padding-bottom: 50px;
            font-family: 'Noto Sans TC', sans-serif;
            /* é è¨­ä½¿ç”¨ Noto Sans TC */
        }

        /* æ•¸å­—å¼·åˆ¶ä½¿ç”¨ Roboto Mono */
        .number-font,
        .amount,
        #totalBankAssets,
        #totalMarketValue,
        #totalUnrealizedPnL,
        #totalRealizedPnL,
        #totalSalePrice,
        #totalCost,
        td:nth-child(n+3) {
            font-family: 'Roboto Mono', monospace;
            font-weight: 500;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header Section */
        header {
            text-align: center;
            color: var(--text-main);
            margin-bottom: 30px;
            padding-top: 20px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
        }

        header p {
            color: var(--text-secondary);
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* Glassmorphism Common Styles */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 24px;
        }

        /* File Upload Section */
        .upload-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        /* New Drag & Drop Zone Styles */
        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            position: relative;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--accent-color);
            background: rgba(56, 189, 248, 0.1);
            /* Sky blue tint */
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .upload-item {
            display: flex;
            flex-direction: column;
        }

        .upload-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        /* Hide default file input */
        .upload-item input[type="file"] {
            display: none;
        }

        /* Custom File Button */
        .custom-file-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .custom-file-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: var(--accent-color);
        }

        /* Primary Action Buttons */
        .action-btn {
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            filter: brightness(1.1);
        }

        .action-btn.primary {
            background: var(--accent-color);
            color: #1e293b;
        }

        .action-btn.danger {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.2);
            /* Darker panel for tabs */
            padding: 5px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--glass-border);
        }

        .tab-btn {
            padding: 12px 30px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
        }

        /* Content Sections */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 25px;
            color: var(--text-main);
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--text-main);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Placeholder Styles */
        .placeholder-text {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .tabs {
                flex-direction: column;
                width: 100%;
                background: transparent;
                padding: 0;
            }

            .tab-btn {
                margin-bottom: 10px;
                background: rgba(255, 255, 255, 0.2);
                width: 100%;
            }

            .tab-btn.active {
                background: white;
            }
        }

        /* Table Styles for Dark Mode */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            color: var(--text-main);
            /* Ensure text is light */
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--accent-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
            /* Subtle hover effect */
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>å€‹äººè³‡ç”¢è¦–è¦ºåŒ–å„€è¡¨æ¿</h1>
            <p>è¼•é¬†è¿½è¹¤éŠ€è¡Œè³‡ç”¢ã€è‚¡ç¥¨åº«å­˜èˆ‡æŠ•è³‡æç›Š</p>
        </header>

        <!-- æª”æ¡ˆä¸Šå‚³å€ -->
        <div class="upload-section">
            <!-- æ‹–æ”¾å€åŸŸ -->
            <div id="dropZone" class="drop-zone">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“‚</div>
                <h3 style="font-size: 1.5rem; margin-bottom: 10px;">æ‹–æ›³æ‰€æœ‰ CSV æª”æ¡ˆè‡³æ­¤</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</p>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="document.getElementById('batchUpload').click()" class="action-btn primary">
                        ğŸš€ é¸æ“‡æª”æ¡ˆ
                    </button>
                    <button onclick="clearAllData()" class="action-btn danger">
                        ğŸ—‘ï¸ æ¸…é™¤
                    </button>
                </div>

                <input type="file" id="batchUpload" accept=".csv" multiple style="display: none;">
                <div id="batchUploadStatus" style="margin-top: 15px; color: var(--text-main); font-weight: 500;"></div>
            </div>

            <!-- å€‹åˆ¥ä¸Šå‚³ Grid -->
            <div class="upload-grid">
                <div class="upload-item">
                    <label>ğŸ¦ éŠ€è¡Œè³‡ç”¢ <span id="bankStatus"
                            style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn">
                        é¸æ“‡æª”æ¡ˆ
                        <input type="file" id="bankFile" accept=".csv" onchange="handleFileUpload(event, 'bankAssets')">
                    </label>
                </div>
                <div class="upload-item">
                    <label>ğŸ“ˆ è‚¡ç¥¨åº«å­˜ <span id="stockStatus"
                            style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn">
                        é¸æ“‡æª”æ¡ˆ
                        <input type="file" id="stockFile" accept=".csv"
                            onchange="handleFileUpload(event, 'stockHoldings')">
                    </label>
                </div>
                <div class="upload-item">
                    <label>ğŸ’¸ å·²å¯¦ç¾æç›Š <span id="pnlStatus"
                            style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn">
                        é¸æ“‡æª”æ¡ˆ
                        <input type="file" id="pnlFile" accept=".csv" onchange="handleFileUpload(event, 'realizedPnL')">
                    </label>
                </div>
                <div class="upload-item">
                    <label>ğŸ“ äº¤æ˜“æ˜ç´° <span id="transStatus"
                            style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn">
                        é¸æ“‡æª”æ¡ˆ
                        <input type="file" id="transFile" accept=".csv"
                            onchange="handleFileUpload(event, 'transactions')">
                    </label>
                </div>
            </div>
        </div>

        <!-- å°è¦½åˆ— -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('assets')">å€‹äººè³‡ç”¢</button>
            <button class="tab-btn" onclick="openTab('stocks')">è‚¡ç¥¨åº«å­˜</button>
            <button class="tab-btn" onclick="openTab('pnl')">å·²å¯¦ç¾æç›Š</button>
            <button class="tab-btn" onclick="openTab('history')">äº¤æ˜“æ­·å²</button>
        </div>

        <!-- 4. äº¤æ˜“æ­·å²åˆ†é  -->
        <div id="history" class="tab-content">
            <div class="dashboard-card">
                <h2 class="section-title">äº¤æ˜“æ­·å²æµæ°´å¸³</h2>
                <div id="historyTableContainer" style="overflow-x: auto;">
                    <div class="placeholder-text">
                        è«‹ä¸Šå‚³äº¤æ˜“æ˜ç´° CSV æª”æ¡ˆä»¥æª¢è¦–å…§å®¹
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. å€‹äººè³‡ç”¢åˆ†é  -->
        <div id="assets" class="tab-content active">

            <!-- æ—¥æœŸé¸æ“‡å™¨ -->
            <div class="dashboard-card"
                style="padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                <label for="bankDateSelect" style="font-weight: bold; color: var(--text-secondary);">ğŸ“… é¸æ“‡æ—¥æœŸ:</label>
                <select id="bankDateSelect" onchange="renderBankAssets(this.value)"
                    style="padding: 8px 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; cursor: pointer; background-color: white;">
                    <option value="">(è«‹å…ˆåŒ¯å…¥è³‡æ–™)</option>
                </select>
            </div>

            <!-- ç¸½è³‡ç”¢å¡ç‰‡ -->
            <div class="dashboard-card" style="text-align: center;">
                <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½è³‡ç”¢</h2>
                <div id="totalBankAssets" style="font-size: 3rem; font-weight: 700; color: var(--accent-color);">
                    $0
                </div>
                <div id="assetsDate" style="color: var(--text-secondary); margin-top: 5px; font-size: 0.9rem;">
                    (å°šæœªè¼‰å…¥è³‡æ–™)
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡ -->
            <div class="dashboard-card">
                <h2 class="section-title">è³‡ç”¢åˆ†ä½ˆ</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="bankPieChart"></canvas>
                </div>
            </div>

            <!-- å¸³æˆ¶æ˜ç´°è¡¨æ ¼ -->
            <div class="dashboard-card">
                <h2 class="section-title">å¸³æˆ¶æ˜ç´°</h2>
                <div id="bankTableContainer" style="overflow-x: auto;">
                    <div class="placeholder-text">
                        è«‹ä¸Šå‚³éŠ€è¡Œè³‡ç”¢ CSV æª”æ¡ˆä»¥æª¢è¦–æ˜ç´°
                    </div>
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡: è³‡ç”¢è¶¨å‹¢åœ– -->
            <div class="dashboard-card">
                <h2 class="section-title">è³‡ç”¢è¶¨å‹¢åœ–</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="assetTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 2. è‚¡ç¥¨åº«å­˜åˆ†é  -->
        <div id="stocks" class="tab-content">
            <!-- æ—¥æœŸé¸æ“‡å™¨ -->
            <div class="dashboard-card"
                style="padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                <label for="stockDateSelect" style="font-weight: bold; color: var(--text-secondary);">ğŸ“… é¸æ“‡æ—¥æœŸ:</label>
                <select id="stockDateSelect" onchange="renderStockHoldings(this.value)"
                    style="padding: 8px 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; cursor: pointer; background-color: white;">
                    <option value="">(è«‹å…ˆåŒ¯å…¥è³‡æ–™)</option>
                </select>
            </div>

            <!-- ç¸½å¸‚å€¼èˆ‡æç›Šå¡ç‰‡ -->
            <div class="dashboard-card" style="text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½å¸‚å€¼</h2>
                        <div id="totalMarketValue"
                            style="font-size: 2.5rem; font-weight: 700; color: var(--accent-color);">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">æœªå¯¦ç¾æç›Š</h2>
                        <div id="totalUnrealizedPnL" style="font-size: 2.5rem; font-weight: 700;">
                            $0
                        </div>
                    </div>
                </div>
                <div id="stockDate" style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">
                    (å°šæœªè¼‰å…¥è³‡æ–™)
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡: æŒè‚¡åˆ†ä½ˆ -->
            <div class="dashboard-card">
                <h2 class="section-title">æŒè‚¡åˆ†ä½ˆ (ä¾å¸‚å€¼)</h2>
                <div class="chart-container" style="height: 400px; position: relative;">
                    <!-- Chart Switcher -->
                    <div style="position: absolute; top: 0; right: 0; z-index: 10; display: flex; gap: 5px;">
                        <button onclick="switchStockChart('pie')" id="btn-chart-pie" class="action-btn primary"
                            style="padding: 5px 12px; font-size: 0.85rem;">åœ“é¤…åœ–</button>
                        <button onclick="switchStockChart('bar')" id="btn-chart-bar" class="action-btn"
                            style="padding: 5px 12px; font-size: 0.85rem; background: rgba(255,255,255,0.1); color: var(--text-color);">é•·æ¢åœ–</button>
                        <button onclick="switchStockChart('bubble')" id="btn-chart-bubble" class="action-btn"
                            style="padding: 5px 12px; font-size: 0.85rem; background: rgba(255,255,255,0.1); color: var(--text-color);">æ°£æ³¡åœ–</button>
                    </div>
                    <canvas id="stockPieChart"></canvas>
                    <!-- <canvas id="stockTreemap" style="display: none;"></canvas> -->
                </div>
            </div>

            <!-- æŒè‚¡æ˜ç´°è¡¨æ ¼ -->
            <div class="dashboard-card">
                <h2 class="section-title">æŒè‚¡æ˜ç´°</h2>
                <div id="stockTableContainer" style="overflow-x: auto;">
                    <div class="placeholder-text">
                        è«‹ä¸Šå‚³è‚¡ç¥¨åº«å­˜ CSV æª”æ¡ˆä»¥æª¢è¦–æ˜ç´°
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. å·²å¯¦ç¾æç›Šåˆ†é  -->
        <div id="pnl" class="tab-content">
            <!-- ç¯©é¸å™¨å€åŸŸ -->
            <div class="dashboard-card" style="margin-bottom: 20px; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="font-weight: bold; color: var(--text-secondary);">ğŸ“… æ—¥æœŸç¯©é¸:</div>
                    <input type="date" id="pnlStartDate"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <span>è‡³</span>
                    <input type="date" id="pnlEndDate"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">

                    <button onclick="applyPnLFilter()"
                        style="background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        ğŸ” ç¯©é¸
                    </button>
                    <button onclick="resetPnLFilter()"
                        style="background: #f1f5f9; color: var(--text-secondary); border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </div>

            <!-- ç¸½æç›Šå¡ç‰‡ -->
            <div class="dashboard-card" style="text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½å·²å¯¦ç¾æç›Š</h2>
                        <div id="totalRealizedPnL" style="font-size: 2.5rem; font-weight: 700;">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½è³£å‡ºåƒ¹</h2>
                        <div id="totalSalePrice"
                            style="font-size: 2.5rem; font-weight: 700; color: var(--accent-color);">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½æˆæœ¬</h2>
                        <div id="totalCost" style="font-size: 2.5rem; font-weight: 700; color: var(--text-secondary);">
                            $0
                        </div>
                    </div>
                </div>
                <div id="pnlDate" style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">
                    (å°šæœªè¼‰å…¥è³‡æ–™)
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡: æç›Šåˆ†ä½ˆ -->
            <div class="dashboard-card">
                <h2 class="section-title">æç›Šåˆ†ä½ˆ (ç›ˆåˆ© vs è™§æ)</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="pnlPieChart"></canvas>
                </div>
            </div>

            <!-- äº¤æ˜“æ˜ç´°è¡¨æ ¼ -->
            <div class="dashboard-card">
                <h2 class="section-title">äº¤æ˜“æ˜ç´°</h2>
                <div id="pnlTableContainer" style="overflow-x: auto;">
                    <div class="placeholder-text">
                        è«‹ä¸Šå‚³å·²å¯¦ç¾æç›Š CSV æª”æ¡ˆä»¥æª¢è¦–æ˜ç´°
                    </div>
                </div>
            </div>
        </div>

        <script>
            // 0. å…¨åŸŸéŒ¯èª¤æ””æˆª (Nuclear Option)
            window.onerror = function (message, source, lineno, colno, error) {
                alert(`ğŸš¨ ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤:\n\nè¨Šæ¯: ${message}\nè¡Œè™Ÿ: ${lineno}\nä¾†æº: ${source}\n\nè«‹æˆªåœ–æ­¤ç•«é¢å›å ±ã€‚`);
                return false;
            };

            // 1. æª¢æŸ¥ç›¸ä¾å¥—ä»¶æ˜¯å¦è¼‰å…¥
            window.onload = function () {
                let missing = [];
                if (typeof Papa === 'undefined') missing.push("PapaParse (è®€å– CSV ç”¨)");
                if (typeof Chart === 'undefined') missing.push("Chart.js (ç•«åœ–ç”¨)");

                if (missing.length > 0) {
                    alert(`âŒ åš´é‡éŒ¯èª¤ï¼šç¼ºå°‘å¿…è¦å…ƒä»¶ï¼\n\n${missing.join('\n')}\n\nå¯èƒ½æ˜¯ç¶²è·¯å•é¡Œå°è‡´ç„¡æ³•è¼‰å…¥ CDNï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚`);
                } else {
                    console.log("âœ… æ‰€æœ‰å…ƒä»¶è¼‰å…¥æˆåŠŸ");
                    initDragAndDrop(); // Initialize Drag & Drop
                }
            }

            // Animation Helper using CountUp.js
            function animateMoney(elementId, amount, prefix = '$') {
                const options = {
                    decimalPlaces: 0,
                    duration: 2.0,
                    prefix: prefix,
                    separator: ',',
                };
                // Check if CountUp is loaded
                if (typeof CountUp === 'undefined') {
                    // Fallback
                    document.getElementById(elementId).textContent = prefix + amount.toLocaleString();
                    return;
                }
                const anim = new CountUp(elementId, amount, options);
                if (!anim.error) {
                    anim.start();
                } else {
                    console.error(anim.error);
                    document.getElementById(elementId).textContent = prefix + amount.toLocaleString();
                }
            }

            // Init Drag & Drop Listeners
            function initDragAndDrop() {
                const dropZone = document.getElementById('dropZone');

                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // Highlight drop zone when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });

                // Handle dropped files
                dropZone.addEventListener('drop', handleDrop, false);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                document.getElementById('dropZone').classList.add('drag-over');
            }

            function unhighlight(e) {
                document.getElementById('dropZone').classList.remove('drag-over');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleBatchFiles(files);
            }

            // Refactored Batch Upload to support both Input and Drop
            function handleBatchUpload(event) {
                const files = event.target.files;
                handleBatchFiles(files);
            }

            // Core Batch Processing Logic
            function handleBatchFiles(fileList) {
                const files = Array.from(fileList);
                if (files.length === 0) return;

                const statusEl = document.getElementById('batchUploadStatus');
                statusEl.textContent = `â³ æ­£åœ¨è™•ç† ${files.length} å€‹æª”æ¡ˆ...`;

                let processed = 0;
                let success = 0;
                const results = [];

                files.forEach(file => {
                    const fileName = file.name.toLowerCase();
                    let targetType = null;
                    let targetInput = null;

                    // æ ¹æ“šæª”ååˆ¤æ–·é¡å‹
                    if (fileName.includes('bank_asset')) {
                        targetType = 'bankAssets';
                        targetInput = document.getElementById('bankFile');
                    } else if (fileName.includes('stock_holding')) {
                        targetType = 'stockHoldings';
                        targetInput = document.getElementById('stockFile');
                    } else if (fileName.includes('realized_pnl')) {
                        targetType = 'realizedPnL';
                        targetInput = document.getElementById('pnlFile');
                    } else if (fileName.includes('transactions')) {
                        targetType = 'transactions';
                        targetInput = document.getElementById('transFile');
                    }

                    if (targetType && targetInput) {
                        // å»ºç«‹è™›æ“¬äº‹ä»¶ä¸¦å‘¼å«åŸæœ‰çš„è™•ç†å‡½å¼
                        const fakeEvent = {
                            target: {
                                files: [file],
                                value: file.name
                            }
                        };

                        try {
                            handleFileUpload(fakeEvent, targetType);
                            results.push(`âœ… ${file.name}`);
                            success++;
                        } catch (err) {
                            results.push(`âŒ ${file.name}: ${err.message}`);
                        }
                    } else {
                        results.push(`âš ï¸ ${file.name}: ç„¡æ³•è­˜åˆ¥æª”æ¡ˆé¡å‹`);
                    }

                    processed++;

                    // å…¨éƒ¨è™•ç†å®Œæˆå¾Œæ›´æ–°ç‹€æ…‹
                    if (processed === files.length) {
                        setTimeout(() => {
                            statusEl.innerHTML = `
                                <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                                    <strong>è™•ç†å®Œæˆï¼š${success}/${files.length} å€‹æª”æ¡ˆæˆåŠŸè¼‰å…¥</strong><br>
                                    ${results.join('<br>')}
                                </div>
                            `;
                        }, 500);
                    }
                });
            }

            // ä¸€éµè¼‰å…¥äº‹ä»¶ç›£è½
            document.getElementById('batchUpload').addEventListener('change', handleBatchUpload);

            // å…¨åŸŸè³‡æ–™å„²å­˜ç‰©ä»¶
            let appData = {
                bankAssets: [],
                stockHoldings: [],
                realizedPnL: [],
                transactions: []
            };

            let charts = {}; // å„²å­˜åœ–è¡¨å¯¦ä¾‹
            let currentStockChartType = 'pie'; // 'pie' or 'treemap'

            // Switch Stock Chart Type
            // Switch Stock Chart Type
            function switchStockChart(type) {
                currentStockChartType = type;

                // Update Buttons
                const btnPie = document.getElementById('btn-chart-pie');
                const btnBar = document.getElementById('btn-chart-bar');
                const btnBubble = document.getElementById('btn-chart-bubble');

                // Reset all styles
                [btnPie, btnBar, btnBubble].forEach(btn => {
                    btn.classList.remove('primary');
                    btn.style.background = 'rgba(255,255,255,0.1)';
                });

                // Hide all canvases (we use the same canvas for Pie/Bar/Bubble basically, or separate?)
                // Actually cleaner to use one canvas and destroy char instance.
                // But previously we had separate partial Canvas. Let's assume we use 'stockPieChart' for everything
                // except Treemap which had its own container maybe?
                // Let's stick to using 'stockPieChart' canvas for ALL standard charts (Pie, Bar, Bubble)
                // and hide Treemap if it exists (though we commented it out in HTML).

                if (type === 'pie') {
                    btnPie.classList.add('primary');
                    btnPie.style.background = 'var(--accent-color)';
                } else if (type === 'bar') {
                    btnBar.classList.add('primary');
                    btnBar.style.background = 'var(--accent-color)';
                } else if (type === 'bubble') {
                    btnBubble.classList.add('primary');
                    btnBubble.style.background = 'var(--accent-color)';
                }

                // Re-render
                renderStockHoldings();
            }

            // è‹¥ ChartDataLabels æ’ä»¶æœ‰è¼‰å…¥ï¼Œå‰‡è¨»å†Šå®ƒ
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
                // è¨­å®šé è¨­å…¨åŸŸè¨­å®šï¼Œé¿å…å½±éŸ¿å…¶ä»–åœ–è¡¨ (ä¹Ÿå¯åœ¨å€‹åˆ¥åœ–è¡¨è¨­å®š)
                Chart.defaults.set('plugins.datalabels', {
                    display: false // é è¨­ä¸é¡¯ç¤ºï¼Œé™¤éå€‹åˆ¥ chart é–‹å•Ÿ
                });
            }

            // CSV æ¬„ä½å®šç¾© (ç”¨æ–¼é©—è­‰æª”æ¡ˆé¡å‹)
            const SCHEMA = {
                bankAssets: ["æ—¥æœŸ", "å¸³æˆ¶åç¨±", "é‡‘é¡"],
                stockHoldings: ["æ—¥æœŸ", "å¸‚å ´", "è‚¡ç¥¨ä»£è™Ÿ", "è‚¡ç¥¨åç¨±", "æŒæœ‰è‚¡æ•¸", "ç¸½æˆæœ¬"], // æ”¾å¯¬æª¢æŸ¥ï¼Œæ”¯æ´æ–°èˆŠç‰ˆæ¬„ä½
                realizedPnL: ["æ—¥æœŸ", "å¸‚å ´", "è‚¡ç¥¨ä»£è™Ÿ", "è‚¡ç¥¨åç¨±", "è³£å‡ºè‚¡æ•¸", "ç¸½æˆæœ¬(åŸå¹£)", "è³£å‡ºåƒ¹(åŸå¹£)", "å·²å¯¦ç¾æç›Š(åŸå¹£)", "ç¸½æˆæœ¬(å°å¹£)", "è³£å‡ºåƒ¹(å°å¹£)", "å·²å¯¦ç¾æç›Š(å°å¹£)", "å ±é…¬ç‡%"],
                transactions: ["æ—¥æœŸ", "ä»£è™Ÿ", "åç¨±", "é¡åˆ¥", "åƒ¹æ ¼", "è‚¡æ•¸", "ç¸½é‡‘é¡"]
            };

            // è¼”åŠ©å‡½å¼ï¼šè§£æé‡‘é¡ (è™•ç† "1,000" å­—ä¸²æˆ–æ•¸å­—)
            function parseMoney(value) {
                if (typeof value === 'number') return value;
                if (typeof value === 'string') {
                    // ç§»é™¤é€—è™Ÿå¾Œè½‰æ•¸å­—
                    const cleanStr = value.replace(/,/g, '').trim();
                    return parseFloat(cleanStr) || 0;
                }
                return 0;
            }

            // è™•ç†æª”æ¡ˆä¸Šå‚³
            function handleFileUpload(event, type) {
                try {
                    // æª¢æŸ¥ Library æ˜¯å¦å­˜åœ¨
                    if (typeof Papa === 'undefined') {
                        throw new Error("PapaParse å…ƒä»¶æœªè¼‰å…¥ï¼Œç„¡æ³•è®€å– CSV");
                    }

                    const file = event.target.files[0];
                    if (!file) return;

                    const statusId = type === 'bankAssets' ? 'bankStatus' :
                        type === 'stockHoldings' ? 'stockStatus' :
                            type === 'realizedPnL' ? 'pnlStatus' : 'transStatus';
                    const statusEl = document.getElementById(statusId);

                    statusEl.textContent = "â³ è®€å–ä¸­...";

                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        // encoding: "UTF-8", // ç§»é™¤å¼·åˆ¶ç·¨ç¢¼
                        dynamicTyping: false,
                        complete: function (results) {
                            try {
                                console.log("Parsing complete for", type, results);
                                const data = results.data;
                                const meta = results.meta;

                                if (!data || data.length === 0) {
                                    // Modified: Allow empty file (header only)
                                    console.warn(`[${type}] CSV has no data rows.`);
                                    // We still check meta.fields to ensure it's a valid empty file
                                }

                                // æª¢æŸ¥ meta.fields æ˜¯å¦å­˜åœ¨
                                if (!meta.fields) {
                                    throw new Error("ç„¡æ³•è®€å– CSV æ¬„ä½ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼");
                                }

                                // 1. æ¬„ä½é©—è­‰ (ä¿®æ­£ BOM)
                                const requiredFields = SCHEMA[type];
                                // ç§»é™¤ BOM ä¸¦å»é™¤ç©ºç™½
                                const fileFields = meta.fields.map(f => typeof f === 'string' ? f.replace(/^\ufeff/, '').trim() : f);

                                const isValid = requiredFields.every(field => fileFields.includes(field));

                                if (!isValid) {
                                    alert(`âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼\nç¼ºå°‘æ¬„ä½: ${requiredFields.filter(f => !fileFields.includes(f)).join(', ')}\nè®€åˆ°çš„æ¬„ä½: ${fileFields.join(', ')}`);
                                    event.target.value = "";
                                    statusEl.textContent = "";
                                    return;
                                }

                                // 2. æ¸…æ´—è³‡æ–™ Key (ç§»é™¤ BOM)
                                const cleanData = data.map(row => {
                                    const newRow = {};
                                    Object.keys(row).forEach(key => {
                                        // ç¢ºä¿ key æ˜¯å­—ä¸²æ‰è™•ç†
                                        const cleanKey = typeof key === 'string' ? key.replace(/^\ufeff/, '').trim() : key;
                                        newRow[cleanKey] = row[key];
                                    });
                                    return newRow;
                                });

                                appData[type] = cleanData;
                                console.log(`âœ… [${type}] Loaded ${cleanData.length} records`);

                                // 3. æ›´æ–°ç‹€æ…‹é¡¯ç¤º (å…ˆæ›´æ–°æ–‡å­—ï¼Œå†ç•«åœ–)
                                statusEl.textContent = `âœ… å·²è¼‰å…¥ ${cleanData.length} ç­†`;

                                // 4. è§¸ç™¼åœ–è¡¨æ›´æ–°
                                if (type === 'bankAssets') {
                                    setTimeout(() => { // ç¨å¾®å»¶é²è®“ UI æ›´æ–°
                                        try {
                                            renderBankAssets();
                                            renderAssetTrend();
                                        } catch (renderErr) {
                                            console.error("Render Error:", renderErr);
                                            alert("åœ–è¡¨ç¹ªè£½å¤±æ•—: " + renderErr.message);
                                        }
                                    }, 50);
                                } else if (type === 'stockHoldings') {
                                    setTimeout(() => {
                                        try {
                                            renderStockHoldings();
                                        } catch (renderErr) {
                                            console.error("Render Error:", renderErr);
                                            alert("åœ–è¡¨ç¹ªè£½å¤±æ•—: " + renderErr.message);
                                        }
                                    }, 50);
                                } else if (type === 'realizedPnL') {
                                    setTimeout(() => {
                                        try {
                                            renderRealizedPnL();
                                        } catch (renderErr) {
                                            console.error("Render Error:", renderErr);
                                            alert("åœ–è¡¨ç¹ªè£½å¤±æ•—: " + renderErr.message);
                                        }
                                    }, 50);
                                } else if (type === 'transactions') {
                                    setTimeout(() => {
                                        try {
                                            renderTransactionHistory();
                                        } catch (renderErr) {
                                            console.error("Render Error:", renderErr);
                                            alert("è¡¨æ ¼ç¹ªè£½å¤±æ•—: " + renderErr.message);
                                        }
                                    }, 50);
                                }
                            } catch (err) {
                                console.error("Processing Error:", err);
                                alert("âŒ è³‡æ–™è™•ç†ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                                statusEl.textContent = "âŒ éŒ¯èª¤";
                            }
                        },
                        error: function (error) {
                            console.error("Error parsing CSV:", error);
                            alert("âŒ æª”æ¡ˆè§£æå¤±æ•—: " + error.message);
                            statusEl.textContent = "âŒ å¤±æ•—";
                        }
                    });
                } catch (e) {
                    console.error("Global Error in handleFileUpload:", e);
                    alert("ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: " + e.message);

                    const statusId = type === 'bankAssets' ? 'bankStatus' :
                        type === 'stockHoldings' ? 'stockStatus' :
                            type === 'realizedPnL' ? 'pnlStatus' : 'transStatus';

                    if (document.getElementById(statusId)) {
                        document.getElementById(statusId).textContent = "âŒ éŒ¯èª¤";
                    }
                }
            }

            // æ¸…é™¤è³‡æ–™
            function clearAllData() {
                if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç›®å‰é¡¯ç¤ºçš„è³‡æ–™å—ï¼Ÿ')) return;

                // 1. é‡ç½®è³‡æ–™ç‰©ä»¶
                appData = {
                    bankAssets: [],
                    stockHoldings: [],
                    realizedPnL: [],
                    transactions: []
                };

                // 2. éŠ·æ¯€æ‰€æœ‰åœ–è¡¨
                Object.keys(charts).forEach(key => {
                    if (charts[key]) {
                        charts[key].destroy();
                        charts[key] = null;
                    }
                });
                charts = {};

                // 3. é‡ç½®æ•¸å­—é¡¯ç¤º
                ['totalBankAssets', 'totalMarketValue', 'totalUnrealizedPnL', 'totalRealizedPnL', 'totalSalePrice', 'totalCost'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '$0';
                    if (el && id === 'totalUnrealizedPnL') el.style.color = ''; // é‡ç½®é¡è‰²
                    if (el && id === 'totalRealizedPnL') el.style.color = '';
                });

                // 4. é‡ç½®æ—¥æœŸèˆ‡ç‹€æ…‹æ–‡å­—
                ['assetsDate', 'stockDate', 'pnlDate'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '(å°šæœªè¼‰å…¥è³‡æ–™)';
                });

                ['bankStatus', 'stockStatus', 'pnlStatus', 'transStatus', 'batchUploadStatus'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '';
                });

                // 5. é‡ç½®è¡¨æ ¼
                document.getElementById('stockTableContainer').innerHTML = '<div class="placeholder-text">è«‹ä¸Šå‚³è‚¡ç¥¨åº«å­˜ CSV æª”æ¡ˆä»¥æª¢è¦–æ˜ç´°</div>';
                document.getElementById('pnlTableContainer').innerHTML = '<div class="placeholder-text">è«‹ä¸Šå‚³å·²å¯¦ç¾æç›Š CSV æª”æ¡ˆä»¥æª¢è¦–æ˜ç´°</div>';
                document.getElementById('historyTableContainer').innerHTML = '<div class="placeholder-text">è«‹ä¸Šå‚³äº¤æ˜“æ˜ç´° CSV æª”æ¡ˆä»¥æª¢è¦–å…§å®¹</div>';

                // 6. æ¸…ç©ºæª”æ¡ˆè¼¸å…¥æ¡†
                document.querySelectorAll('input[type="file"]').forEach(input => input.value = '');

                // alert('å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼');
            }


            // æ¸²æŸ“éŠ€è¡Œè³‡ç”¢åœ“é¤…åœ– (æœ€æ–°æœˆä»½)
            // targetDate: æŒ‡å®šè¦æ¸²æŸ“çš„æ—¥æœŸå­—ä¸² (YYYY/MM/DD)ï¼Œè‹¥ç„¡å‰‡é è¨­æœ€æ–°
            function renderBankAssets(targetDate = null) {
                const data = appData.bankAssets;
                if (!data || data.length === 0) return;

                // 1. æ‰¾å‡ºæ‰€æœ‰æ—¥æœŸä¸¦æ’åº (æ–° -> èˆŠ)
                const uniqueDates = [...new Set(data.map(item => item['æ—¥æœŸ']))].sort().reverse();

                // 2. æ›´æ–°ä¸‹æ‹‰é¸å–® (å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“æˆ–è³‡æ–™æ›´æ–°)
                const selectEl = document.getElementById('bankDateSelect');
                if (targetDate === null || selectEl.options.length <= 1) {
                    selectEl.innerHTML = '';
                    uniqueDates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        selectEl.appendChild(option);
                    });
                    // é è¨­é¸å–æœ€æ–°
                    selectEl.value = uniqueDates[0];
                }

                // 3. æ±ºå®šè¦é¡¯ç¤ºçš„æ—¥æœŸ
                const selectedDate = targetDate || selectEl.value || uniqueDates[0];

                // ç¢ºä¿é¸å–®é¡¯ç¤ºæ­£ç¢º
                if (selectEl.value !== selectedDate) {
                    selectEl.value = selectedDate;
                }

                // 4. éæ¿¾è©²æ—¥æœŸçš„è³‡æ–™
                const currentData = data.filter(item => item['æ—¥æœŸ'] === selectedDate);

                if (currentData.length === 0) {
                    alert('æŸ¥ç„¡è©²æ—¥æœŸçš„è³‡ç”¢è³‡æ–™');
                    return;
                }

                // 5. è¨ˆç®—ç¸½é‡‘é¡
                const totalAmount = currentData.reduce((sum, item) => sum + parseMoney(item['é‡‘é¡']), 0);

                // 6. æ›´æ–° DOM
                animateMoney('totalBankAssets', totalAmount);
                document.getElementById('assetsDate').textContent = `è³‡æ–™æ—¥æœŸ: ${selectedDate}`;

                // 7. æº–å‚™åœ–è¡¨è³‡æ–™
                const labels = currentData.map(item => item['å¸³æˆ¶åç¨±']);
                const amounts = currentData.map(item => parseMoney(item['é‡‘é¡']));

                // 8. ç¹ªè£½åœ“é¤…åœ–
                const ctx = document.getElementById('bankPieChart').getContext('2d');

                if (charts['bankPie']) {
                    charts['bankPie'].destroy();
                }

                charts['bankPie'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: amounts,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#FF5733', '#33FF57', '#3357FF', '#F333FF'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 16
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18 // æ”¾å¤§ Tooltip æ¨™é¡Œ
                                },
                                bodyFont: {
                                    size: 18 // æ”¾å¤§ Tooltip å…§å®¹
                                },
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw;
                                        const percentage = ((value / totalAmount) * 100).toFixed(1) + '%';
                                        label += `$${value.toLocaleString()} (${percentage})`;
                                        return label;
                                    }
                                }
                            },
                            // è¨­å®š datalabels (ç›´æ¥é¡¯ç¤ºåœ¨åœ–ä¸Š)
                            datalabels: {
                                display: true, // å¼·åˆ¶é¡¯ç¤º
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 16 // æ”¾å¤§åœ“é¤…åœ–ä¸Šçš„æ–‡å­—
                                },
                                formatter: function (value, context) {
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const percentage = ((value / totalAmount) * 100).toFixed(1) + '%';
                                    // å¦‚æœæ¯”ä¾‹å¤ªå° (<5%) å°±ä¸é¡¯ç¤ºï¼Œé¿å…æ“ åœ¨ä¸€èµ·
                                    if ((value / totalAmount) < 0.05) return null;
                                    return label + '\n' + percentage;
                                },
                                textAlign: 'center'
                            }
                        }
                    }
                });

                // 9. ç¹ªè£½æ˜ç´°è¡¨æ ¼
                renderBankTable(currentData);
            }

            // æ¸²æŸ“éŠ€è¡Œå¸³æˆ¶æ˜ç´°è¡¨æ ¼
            function renderBankTable(data) {
                const container = document.getElementById('bankTableContainer');

                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 1rem;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">å¸³æˆ¶åç¨±</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">é‡‘é¡</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ä½”æ¯”</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // è¨ˆç®—ç¸½é‡‘é¡ç”¨æ–¼é¡¯ç¤ºä½”æ¯”
                const totalAmount = data.reduce((sum, item) => sum + parseMoney(item['é‡‘é¡']), 0);

                // ä¾ç…§é‡‘é¡æ’åº (å¤§ -> å°)
                const sortedData = [...data].sort((a, b) => parseMoney(b['é‡‘é¡']) - parseMoney(a['é‡‘é¡']));

                sortedData.forEach((item, index) => {
                    const amount = parseMoney(item['é‡‘é¡']);
                    const percentage = totalAmount > 0 ? ((amount / totalAmount) * 100).toFixed(1) + '%' : '0%';

                    tableHTML += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); font-weight: bold; color: var(--text-color);">${item['å¸³æˆ¶åç¨±'] || '-'}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1); font-family: monospace; font-size: 1.1rem;">$${amount.toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">${percentage}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;
            }

            // æ¸²æŸ“è³‡ç”¢æ­·å²è¶¨å‹¢åœ– (æŠ˜ç·šåœ–)
            function renderAssetTrend() {
                const data = appData.bankAssets;
                if (!data || data.length === 0) return;

                // 1. æ•´ç†æ¯æ—¥ç¸½è³‡ç”¢
                let dailyTotals = {};
                data.forEach(item => {
                    const date = item['æ—¥æœŸ'];

                    // éæ¿¾ç„¡æ•ˆæ—¥æœŸ (ç©ºç™½ã€nullã€undefined)
                    if (!date || typeof date !== 'string' || date.trim() === '') {
                        return;
                    }

                    const amount = parseMoney(item['é‡‘é¡']);
                    if (!dailyTotals[date]) {
                        dailyTotals[date] = 0;
                    }
                    dailyTotals[date] += amount;
                });

                // 2. æ’åºæ—¥æœŸ
                const sortedDates = Object.keys(dailyTotals).sort();
                const sortedAmounts = sortedDates.map(date => dailyTotals[date]);

                // 3. ç¹ªè£½æŠ˜ç·šåœ–
                const ctx = document.getElementById('assetTrendChart').getContext('2d');

                if (charts['assetTrend']) {
                    charts['assetTrend'].destroy();
                }

                charts['assetTrend'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'ç¸½è³‡ç”¢',
                            data: sortedAmounts,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#764ba2',
                            pointRadius: 5,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            datalabels: {
                                display: false // æŠ˜ç·šåœ–ä¸é¡¯ç¤º datalabels
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18 // æ”¾å¤§ Tooltip æ¨™é¡Œ
                                },
                                bodyFont: {
                                    size: 18 // æ”¾å¤§ Tooltip å…§å®¹
                                },
                                intersect: false,
                                mode: 'index',
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += '$' + context.parsed.y.toLocaleString();
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    stepSize: 100000,
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    callback: function (value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }
            function renderStockHoldings(targetDate = null) {
                const data = appData.stockHoldings;
                if (!data || data.length === 0) return;

                // 1. æ‰¾å‡ºæ‰€æœ‰æ—¥æœŸä¸¦æ’åº (æ–° -> èˆŠ)
                const uniqueDates = [...new Set(data.map(item => item['æ—¥æœŸ']))].sort().reverse();

                // 2. æ›´æ–°ä¸‹æ‹‰é¸å–® (å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“æˆ–è³‡æ–™æ›´æ–°)
                const selectEl = document.getElementById('stockDateSelect');
                // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœé¸å–®é¸é …æ•¸é‡è·Ÿæ—¥æœŸæ•¸é‡ä¸ä¸€è‡´(åŠ 1å€‹é è¨­)ï¼Œæˆ–è€…é¸å–®ç›®å‰æ˜¯é è¨­æ–‡å­—ï¼Œå°±é‡ç¹ª
                // æ³¨æ„ï¼šé€™æœƒé‡ç½®ä½¿ç”¨è€…ç›®å‰çš„é¸æ“‡ï¼Œä½†åœ¨è³‡æ–™é‡æ–°åŒ¯å…¥æ™‚æ˜¯åˆç†çš„
                // ç‚ºäº†é¿å…åœ¨åˆ‡æ›æ—¥æœŸæ™‚é‡ç¹ªé¸å–®ï¼Œæˆ‘å€‘æª¢æŸ¥ targetDate æ˜¯å¦ç‚ºäº‹ä»¶è§¸ç™¼ (string)

                // è‹¥ targetDate ç‚º null (è¡¨ç¤ºå‰›åŒ¯å…¥è³‡æ–™)ï¼Œå‰‡é‡å»ºé¸å–®
                if (targetDate === null || selectEl.options.length <= 1) {
                    selectEl.innerHTML = '';
                    uniqueDates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        selectEl.appendChild(option);
                    });
                    // é è¨­é¸å–æœ€æ–°
                    selectEl.value = uniqueDates[0];
                }

                // 3. æ±ºå®šè¦é¡¯ç¤ºçš„æ—¥æœŸ
                // å¦‚æœ targetDate æœ‰å€¼ï¼Œå°±ç”¨å®ƒï¼›å¦å‰‡ç”¨é¸å–®ç›®å‰çš„å€¼ï¼›å†æ²’æœ‰å°±ç”¨æœ€æ–°æ—¥æœŸ
                const selectedDate = targetDate || selectEl.value || uniqueDates[0];

                // ç¢ºä¿é¸å–®é¡¯ç¤ºæ­£ç¢º (å¦‚æœæ˜¯å¤–éƒ¨å‘¼å«å°è‡´ filter æ”¹è®Š)
                if (selectEl.value !== selectedDate) {
                    selectEl.value = selectedDate;
                }

                // 4. éæ¿¾è©²æ—¥æœŸçš„è³‡æ–™
                const currentData = data.filter(item => item['æ—¥æœŸ'] === selectedDate);

                if (currentData.length === 0) {
                    alert('æŸ¥ç„¡è©²æ—¥æœŸçš„åº«å­˜è³‡æ–™');
                    return;
                }

                // 5. è¨ˆç®—ç¸½å¸‚å€¼èˆ‡ç¸½æœªå¯¦ç¾æç›Š
                const totalMarketValue = currentData.reduce((sum, item) => sum + parseMoney(item['å¸‚å€¼(å°å¹£)'] || item['å¸‚å€¼']), 0);
                const totalUnrealizedPnL = currentData.reduce((sum, item) => sum + parseMoney(item['æœªå¯¦ç¾æç›Š']), 0);

                // 6. æ›´æ–° DOM
                // document.getElementById('totalMarketValue').textContent = `$${totalMarketValue.toLocaleString()}`;
                animateMoney('totalMarketValue', totalMarketValue);

                const pnlEl = document.getElementById('totalUnrealizedPnL');
                // pnlEl.textContent = `$${totalUnrealizedPnL.toLocaleString()}`;
                animateMoney('totalUnrealizedPnL', totalUnrealizedPnL, totalUnrealizedPnL >= 0 ? '$' : '-$');
                pnlEl.style.color = totalUnrealizedPnL >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                document.getElementById('stockDate').textContent = `è³‡æ–™æ—¥æœŸ: ${selectedDate}`;

                // 7. æº–å‚™åœ–è¡¨è³‡æ–™
                const stockLabels = currentData.map(item => item['è‚¡ç¥¨åç¨±'] || item['è‚¡ç¥¨ä»£è™Ÿ']);
                const stockValues = currentData.map(item => parseMoney(item['å¸‚å€¼(å°å¹£)'] || item['å¸‚å€¼']));

                // 8. æ¸²æŸ“åœ–è¡¨ (Pie, Bar, or Bubble)
                if (currentStockChartType === 'pie') {
                    renderStockPieChart(stockLabels, stockValues, totalMarketValue);
                } else if (currentStockChartType === 'bar') {
                    renderStockBarChart(currentData);
                } else if (currentStockChartType === 'bubble') {
                    renderStockBubbleChart(currentData);
                } else {
                    // Fallback or Treemap if needed later
                    // renderStockTreemap(currentData);
                }

                // 9. ç¹ªè£½æ˜ç´°è¡¨æ ¼
                renderStockTable(currentData);
            }

            // æ¸²æŸ“æŒè‚¡åœ“é¤…åœ–
            function renderStockPieChart(labels, marketValues, totalMarketValue) {
                const ctx = document.getElementById('stockPieChart').getContext('2d');

                if (charts['stockPie']) {
                    charts['stockPie'].destroy();
                }
                // Ensure treemap chart is destroyed if it exists
                if (charts['stockTreemap']) {
                    charts['stockTreemap'].destroy();
                    charts['stockTreemap'] = null;
                }

                charts['stockPie'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: marketValues,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#FF5733', '#33FF57', '#3357FF', '#F333FF',
                                '#8A2BE2', '#A52A2A', '#DEB887', '#5F9EA0', '#7FFF00',
                                '#D2691E', '#FF7F50', '#6495ED', '#DC143C', '#00FFFF'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 14
                                    },
                                    padding: 15,
                                    color: '#fff' // Fixed: Bright text for dark mode
                                }
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18
                                },
                                bodyFont: {
                                    size: 18
                                },
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw;
                                        const percentage = ((value / totalMarketValue) * 100).toFixed(1) + '%';
                                        label += `$${value.toLocaleString()} (${percentage})`;
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: (value, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => {
                                        sum += data;
                                    });
                                    let percentage = (value * 100 / sum).toFixed(1) + "%";
                                    return percentage;
                                },
                                textAlign: 'center'
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }

            // æ¸²æŸ“æŒè‚¡æ©«å‘æ’é•·æ¢åœ– (Horizontal Bar)
            function renderStockBarChart(data) {
                const ctx = document.getElementById('stockPieChart').getContext('2d');
                if (charts['stockPie']) charts['stockPie'].destroy();

                // Sort by Market Value Desc
                const sortedData = [...data].sort((a, b) => {
                    const valA = parseMoney(a['å¸‚å€¼(å°å¹£)'] || a['å¸‚å€¼']);
                    const valB = parseMoney(b['å¸‚å€¼(å°å¹£)'] || b['å¸‚å€¼']);
                    return valB - valA;
                });

                const labels = sortedData.map(item => item['è‚¡ç¥¨åç¨±'] || item['è‚¡ç¥¨ä»£è™Ÿ']);
                const values = sortedData.map(item => parseMoney(item['å¸‚å€¼(å°å¹£)'] || item['å¸‚å€¼']));
                const colors = sortedData.map(item => {
                    const pnl = parseMoney(item['æœªå¯¦ç¾æç›Š']);
                    return pnl >= 0 ? 'rgba(72, 187, 120, 0.8)' : 'rgba(245, 101, 101, 0.8)'; // Green/Red
                });

                charts['stockPie'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å¸‚å€¼',
                            data: values,
                            backgroundColor: colors,
                            borderRadius: 6,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const val = context.raw;
                                        return `å¸‚å€¼: $${val.toLocaleString()}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: 'white',
                                anchor: 'end',
                                align: 'end',
                                formatter: (val) => `$${(val / 10000).toFixed(1)}è¬`,
                                font: { weight: 'bold' }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'var(--text-secondary)' }
                            },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    color: 'white',
                                    font: { size: 14, weight: 'bold', family: "'Noto Sans TC'" }
                                }
                            }
                        },
                        animation: { duration: 1500, easing: 'easeOutQuart' }
                    }
                });
            }

            // æ¸²æŸ“æŒè‚¡ç¸¾æ•ˆæ°£æ³¡åœ– (Performance Bubble)
            function renderStockBubbleChart(data) {
                const ctx = document.getElementById('stockPieChart').getContext('2d');
                if (charts['stockPie']) charts['stockPie'].destroy();

                const bubbleData = data.map(item => {
                    const mktVal = parseMoney(item['å¸‚å€¼(å°å¹£)'] || item['å¸‚å€¼']);
                    const cost = parseMoney(item['ç¸½æˆæœ¬']);
                    const pnl = parseMoney(item['æœªå¯¦ç¾æç›Š']);
                    const roi = parseMoney(item['å ±é…¬ç‡%']);

                    // Simple scaling: sqrt(cost) to avoid huge bubbles, then factor down
                    const r = Math.sqrt(cost) / 15;

                    return {
                        x: roi,
                        y: mktVal,
                        r: Math.max(r, 5), // Min size 5
                        name: item['è‚¡ç¥¨åç¨±'] || item['è‚¡ç¥¨ä»£è™Ÿ'],
                        rawCost: cost,
                        rawPnl: pnl
                    };
                });

                charts['stockPie'] = new Chart(ctx, {
                    type: 'bubble',
                    data: {
                        datasets: [{
                            label: 'æŒè‚¡',
                            data: bubbleData,
                            backgroundColor: (ctx) => {
                                const val = ctx.raw?.x;
                                return val >= 0 ? 'rgba(72, 187, 120, 0.7)' : 'rgba(245, 101, 101, 0.7)';
                            },
                            borderColor: (ctx) => {
                                const val = ctx.raw?.x;
                                return val >= 0 ? '#48bb78' : '#f56565';
                            },
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const d = context.raw;
                                        return [
                                            d.name,
                                            `å ±é…¬ç‡: ${d.x.toFixed(2)}%`,
                                            `å¸‚å€¼: $${d.y.toLocaleString()}`,
                                            `æˆæœ¬: $${d.rawCost.toLocaleString()}`,
                                            `æç›Š: $${d.rawPnl.toLocaleString()}`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: 'white',
                                align: 'top',
                                formatter: (val, ctx) => ctx.chart.data.datasets[0].data[ctx.dataIndex].name,
                                font: { weight: 'bold', size: 12 }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'å ±é…¬ç‡ (%)', color: '#cbd5e1' },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'white' }
                            },
                            y: {
                                title: { display: true, text: 'å¸‚å€¼ ($)', color: '#cbd5e1' },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'white' },
                                beginAtZero: true
                            }
                        },
                        animation: { duration: 1500, easing: 'easeOutQuart' }
                    }
                });
            }

            // Duplicate function removed

            // æ¸²æŸ“æŒè‚¡çŸ©å½¢æ¨¹ç‹€åœ– (Treemap)
            function renderStockTreemap_OLD(data) {
                const ctx = document.getElementById('stockTreemap').getContext('2d');

                // Destroy existing charts
                if (charts['stockTreemap']) {
                    charts['stockTreemap'].destroy();
                }

                // Prepare Data
                // Chart.js Treemap expects a 'tree' array
                const treemapData = data.map(item => {
                    const marketValue = parseMoney(item['å¸‚å€¼(å°å¹£)'] || item['å¸‚å€¼']);
                    const pnl = parseMoney(item['æœªå¯¦ç¾æç›Š']);
                    const pnlColor = pnl >= 0 ? '#48bb78' : '#f56565'; // Green/Red
                    return {
                        value: marketValue,
                        name: item['è‚¡ç¥¨åç¨±'] || item['è‚¡ç¥¨ä»£è™Ÿ'],
                        code: item['è‚¡ç¥¨ä»£è™Ÿ'],
                        pnl: pnl,
                        pnlFormatted: pnl >= 0 ? `+${pnl.toLocaleString()}` : `${pnl.toLocaleString()}`,
                        color: pnlColor
                    };
                }).sort((a, b) => b.value - a.value); // Sort by Size

                charts['stockTreemap'] = new Chart(ctx, {
                    type: 'treemap',
                    data: {
                        datasets: [{
                            tree: treemapData,
                            key: 'value',
                            groups: ['name'], // Only one level for now
                            spacing: 1,
                            borderWidth: 1,
                            borderColor: '#fff',
                            backgroundColor: (ctx) => {
                                if (ctx.type !== 'data') return 'transparent';
                                // Fix: Access _data to get custom properties
                                return ctx.raw._data ? ctx.raw._data.color : '#ccc';
                            },
                            labels: {
                                display: true,
                                align: 'center',
                                position: 'center',
                                color: 'white',
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: "'Noto Sans TC', sans-serif"
                                },
                                formatter: (ctx) => {
                                    if (ctx.type !== 'data') return;
                                    const item = ctx.raw;
                                    const total = treemapData.reduce((acc, cur) => acc + cur.value, 0);
                                    const percent = ((item._data.value / total) * 100).toFixed(1) + '%';

                                    // Multi-line label
                                    return [
                                        item._data.name,
                                        percent
                                    ];
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (items) => {
                                        return items[0].raw._data.name + ' (' + items[0].raw._data.code + ')';
                                    },
                                    label: (item) => {
                                        const d = item.raw._data;
                                        return [
                                            `å¸‚å€¼: $${d.value.toLocaleString()}`,
                                            `æœªå¯¦ç¾æç›Š: ${d.pnlFormatted}`
                                        ];
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }

            // æ¸²æŸ“æŒè‚¡æ˜ç´°è¡¨æ ¼
            function renderStockTable(data) {
                const container = document.getElementById('stockTableContainer');

                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">å¸‚å ´</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨ä»£è™Ÿ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨åç¨±</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">æŒæœ‰è‚¡æ•¸</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å¹³å‡æˆæœ¬</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ç¸½æˆæœ¬</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å¹£åˆ¥</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ç¸½å¸‚å€¼(å°å¹£)</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">æœªå¯¦ç¾æç›Š</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å ±é…¬ç‡%</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach((item, index) => {
                    const qty = parseMoney(item['æŒæœ‰è‚¡æ•¸']);
                    const cost = parseMoney(item['ç¸½æˆæœ¬']);

                    const avgCost = qty > 0 ? (cost / qty) : 0;

                    const pnl = parseMoney(item['æœªå¯¦ç¾æç›Š']);
                    const pnlColor = pnl >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                    const returnRate = parseMoney(item['å ±é…¬ç‡%']);
                    const returnColor = returnRate >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                    tableHTML += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['å¸‚å ´'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['è‚¡ç¥¨ä»£è™Ÿ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['è‚¡ç¥¨åç¨±'] || '-'}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">${qty.toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">$${avgCost.toFixed(1)}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">$${cost.toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">${item['å¹£åˆ¥'] || 'TWD'}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">$${parseMoney(item['å¸‚å€¼(å°å¹£)'] || item['å¸‚å€¼']).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1); color: ${pnlColor}; font-weight: 600;">
                                ${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString()}
                            </td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1); color: ${returnColor}; font-weight: 600;">
                                ${returnRate >= 0 ? '+' : ''}${returnRate.toFixed(2)}%
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;
            }

            // NEW Robust Treemap Implementation
            function renderStockTreemap(data) {
                const ctx = document.getElementById('stockTreemap').getContext('2d');

                // Destroy existing charts
                if (charts['stockTreemap']) {
                    charts['stockTreemap'].destroy();
                }

                // Prepare Data
                const treemapData = data.map(item => {
                    const marketValue = parseMoney(item['å¸‚å€¼(å°å¹£)'] || item['å¸‚å€¼']);
                    const pnl = parseMoney(item['æœªå¯¦ç¾æç›Š']);
                    const pnlColor = pnl >= 0 ? '#48bb78' : '#f56565'; // Green for profit, Red for loss
                    return {
                        value: marketValue,
                        name: item['è‚¡ç¥¨åç¨±'] || item['è‚¡ç¥¨ä»£è™Ÿ'],
                        code: item['è‚¡ç¥¨ä»£è™Ÿ'],
                        pnl: pnl,
                        pnlFormatted: pnl >= 0 ? `+${pnl.toLocaleString()}` : `${pnl.toLocaleString()}`,
                        color: pnlColor
                    };
                }).sort((a, b) => b.value - a.value);

                // Create maps for safe lookup
                const colorMap = treemapData.reduce((acc, item) => {
                    acc[item.name] = item.color;
                    return acc;
                }, {});

                const pnlMap = treemapData.reduce((acc, item) => {
                    acc[item.name] = item.pnlFormatted;
                    return acc;
                }, {});

                charts['stockTreemap'] = new Chart(ctx, {
                    type: 'treemap',
                    data: {
                        datasets: [{
                            tree: treemapData,
                            key: 'value',
                            groups: ['name'],
                            spacing: 1,
                            borderWidth: 1,
                            borderColor: '#333',
                            backgroundColor: (ctx) => {
                                if (ctx.type !== 'data' || !ctx.raw) return 'transparent';
                                const name = ctx.raw.l; // Label/Name from group
                                return colorMap[name] || '#666';
                            },
                            labels: {
                                display: true,
                                align: 'center',
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: "'Noto Sans TC', sans-serif"
                                },
                                color: 'white',
                                formatter: (ctx) => {
                                    if (ctx.type !== 'data' || !ctx.raw) return;
                                    const value = ctx.raw.v;
                                    const name = ctx.raw.l;
                                    const total = treemapData.reduce((acc, cur) => acc + cur.value, 0);
                                    const percent = ((value / total) * 100).toFixed(1) + '%';
                                    const pnlText = pnlMap[name] || '';
                                    return [name, pnlText + ' (' + percent + ')'];
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (items) => items[0].raw.l,
                                    label: (item) => {
                                        const val = item.raw.v;
                                        return `å¸‚å€¼: $${val.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }

            // æ¸²æŸ“äº¤æ˜“æ­·å²æµæ°´å¸³
            function renderTransactionHistory() {
                const data = appData.transactions || [];
                const container = document.getElementById('historyTableContainer');

                if (data.length === 0) {
                    container.innerHTML = '<div class="placeholder-text">å°šç„¡äº¤æ˜“è³‡æ–™</div>';
                    return;
                }

                // æŒ‰æ—¥æœŸé™åºæ’åº
                const sortedData = [...data].sort((a, b) => {
                    // Date format typically YYYYMMDD in transactions.csv
                    // or maybe formatted string? The CSV generator outputs "YYYYMMDD".
                    // But checking logic above, Schema expects "æ—¥æœŸ".
                    const dateA = String(a['æ—¥æœŸ'] || '');
                    const dateB = String(b['æ—¥æœŸ'] || '');
                    return dateB.localeCompare(dateA);
                });

                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">æ—¥æœŸ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">ä»£è™Ÿ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">åç¨±</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">é¡åˆ¥</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">æˆäº¤åƒ¹</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">è‚¡æ•¸</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ç¸½é‡‘é¡ (å«ç¨…è²»)</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedData.forEach((item, index) => {
                    const type = item['é¡åˆ¥'];
                    // Buy usually Red or Green? 
                    // In Taiwan: Buy = Red (Bull), Sell = Green (Bear). 
                    // But "Type" label color: 
                    // Buy -> Expense (Blue/Black?), Sell -> Income.
                    // Let's use simple badges.
                    const typeColor = type === 'è²·é€²' ? '#d32f2f' : (type === 'è³£å‡º' ? '#388e3c' : '#aaa');
                    const typeLabel = `<span style="color: ${typeColor}; font-weight: bold;">${type}</span>`;

                    const price = parseMoney(item['åƒ¹æ ¼']);
                    const qty = parseMoney(item['è‚¡æ•¸']);
                    const total = parseMoney(item['ç¸½é‡‘é¡']);

                    tableHTML += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['æ—¥æœŸ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['ä»£è™Ÿ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['åç¨±'] || '-'}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">${typeLabel}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">$${price.toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">${qty.toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1); font-weight:bold;">$${total.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary);">${item['å‚™è¨»'] || ''}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;
            }

            // æ¸²æŸ“å·²å¯¦ç¾æç›Š (åœ“é¤…åœ– + æ˜ç´°è¡¨)
            // æ”¯æ´å‚³å…¥éæ¿¾å¾Œçš„è³‡æ–™ (filteredData)ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨å…¨éƒ¨
            function renderRealizedPnL(filteredData = null) {
                const data = filteredData || appData.realizedPnL;
                if (!data || data.length === 0) {
                    // å¦‚æœæ˜¯å› ç‚ºç¯©é¸å¾Œè®Šç©ºï¼Œä¹Ÿè¦æ›´æ–° UI é¡¯ç¤º 0
                    if (filteredData) {
                        // æ¸…ç©ºé¡¯ç¤º
                        document.getElementById('totalRealizedPnL').textContent = '$0';
                        document.getElementById('totalSalePrice').textContent = '$0';
                        document.getElementById('totalCost').textContent = '$0';
                        document.getElementById('pnlDate').textContent = `æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™`;
                        if (charts['pnlPie']) { charts['pnlPie'].destroy(); charts['pnlPie'] = null; }
                        document.getElementById('pnlTableContainer').innerHTML = '<div class="placeholder-text">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
                    }
                    return;
                }

                // 2. æ‰¾å‡ºè³‡æ–™æ—¥æœŸç¯„åœï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
                // å…ˆè¤‡è£½ä¸€ä»½ä¸¦æ’åº
                const sortedDataByDate = [...data].sort((a, b) => new Date(a['æ—¥æœŸ']) - new Date(b['æ—¥æœŸ']));
                const startDate = sortedDataByDate[0]['æ—¥æœŸ'];
                const endDate = sortedDataByDate[sortedDataByDate.length - 1]['æ—¥æœŸ'];

                const dateRange = startDate === endDate ? startDate : `${startDate} ~ ${endDate}`;

                // 3. è¨ˆç®—ç¸½å·²å¯¦ç¾æç›Šã€ç¸½è³£å‡ºåƒ¹ã€ç¸½æˆæœ¬ (ä½¿ç”¨å°å¹£åŠ ç¸½)
                const totalRealizedPnL = data.reduce((sum, item) => sum + parseMoney(item['å·²å¯¦ç¾æç›Š(å°å¹£)'] || item['å·²å¯¦ç¾æç›Š']), 0);
                const totalSalePrice = data.reduce((sum, item) => sum + parseMoney(item['è³£å‡ºåƒ¹(å°å¹£)'] || item['è³£å‡ºåƒ¹']), 0);
                const totalCost = data.reduce((sum, item) => sum + parseMoney(item['ç¸½æˆæœ¬(å°å¹£)'] || item['ç¸½æˆæœ¬']), 0);

                // 4. æ›´æ–° DOM
                const pnlEl = document.getElementById('totalRealizedPnL');
                // pnlEl.textContent = `$${totalRealizedPnL.toLocaleString()}`;
                animateMoney('totalRealizedPnL', Math.abs(totalRealizedPnL), totalRealizedPnL >= 0 ? '$' : '-$');
                pnlEl.style.color = totalRealizedPnL >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                // document.getElementById('totalSalePrice').textContent = `$${totalSalePrice.toLocaleString()}`;
                animateMoney('totalSalePrice', totalSalePrice);

                // document.getElementById('totalCost').textContent = `$${totalCost.toLocaleString()}`;
                animateMoney('totalCost', totalCost);
                document.getElementById('pnlDate').textContent = `è³‡æ–™æœŸé–“: ${dateRange} (å…± ${data.length} ç­†äº¤æ˜“)`;
                // ... ç¹¼çºŒå¾Œé¢çš„åœ–è¡¨èˆ‡è¡¨æ ¼æ¸²æŸ“

                // 5. è¨ˆç®—ç›ˆåˆ©/è™§æäº¤æ˜“çš„é‡‘é¡
                let profitAmount = 0;
                let lossAmount = 0;

                data.forEach(item => {
                    const pnl = parseMoney(item['å·²å¯¦ç¾æç›Š(å°å¹£)'] || item['å·²å¯¦ç¾æç›Š']); // Use TWD

                    if (pnl > 0) {
                        profitAmount += pnl;
                    } else if (pnl < 0) {
                        lossAmount += Math.abs(pnl);
                    }
                });

                // 6. æº–å‚™åœ“é¤…åœ–è³‡æ–™ (ç›ˆåˆ© vs è™§æ)
                const labels = ['ç›ˆåˆ©', 'è™§æ'];
                const amounts = [profitAmount, lossAmount];
                const colors = ['var(--success-color)', 'var(--danger-color)'];

                // 7. ç¹ªè£½åœ“é¤…åœ–
                const ctx = document.getElementById('pnlPieChart').getContext('2d');

                if (charts['pnlPie']) {
                    charts['pnlPie'].destroy();
                }

                charts['pnlPie'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: amounts,
                            backgroundColor: ['#33FF57', '#FF5733'], // è¢å…‰ç¶ ã€é®®ç´…
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 16
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18
                                },
                                bodyFont: {
                                    size: 18
                                },
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw;
                                        const total = profitAmount + lossAmount;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                        label += `$${value.toLocaleString()} (${percentage})`;
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 16
                                },
                                formatter: function (value, context) {
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const total = profitAmount + lossAmount;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    return label + '\n' + percentage;
                                },
                                textAlign: 'center'
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutQuart'
                        }
                    }
                });

                // 8. ç¹ªè£½æ˜ç´°è¡¨æ ¼ï¼ˆæŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
                const sortedData = data.sort((a, b) => { // Fix: use data instead of allData
                    const dateA = String(a['æ—¥æœŸ'] || '');
                    const dateB = String(b['æ—¥æœŸ'] || '');
                    return dateB.localeCompare(dateA); // é™åºæ’åˆ—
                });
                renderPnLTable(sortedData);
            }

            // æ‡‰ç”¨æç›Šç¯©é¸
            function applyPnLFilter() {
                const startStr = document.getElementById('pnlStartDate').value;
                const endStr = document.getElementById('pnlEndDate').value;

                if (!appData.realizedPnL || appData.realizedPnL.length === 0) {
                    alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä¾›ç¯©é¸");
                    return;
                }

                if (!startStr && !endStr) {
                    renderRealizedPnL(); // æ²’é¸å°±é¡¯ç¤ºå…¨éƒ¨
                    return;
                }

                const startDate = startStr ? new Date(startStr.replace(/-/g, '/')) : null;
                const endDate = endStr ? new Date(endStr.replace(/-/g, '/')) : null;

                const filtered = appData.realizedPnL.filter(item => {
                    // è³‡æ–™æ—¥æœŸæ ¼å¼é€šå¸¸æ˜¯ yyyy/MM/ddï¼Œè½‰ Date
                    const itemDate = new Date(item['æ—¥æœŸ']);

                    if (startDate && itemDate < startDate) return false;
                    if (endDate && itemDate > endDate) return false;

                    return true;
                });

                renderRealizedPnL(filtered);
            }

            // é‡ç½®æç›Šç¯©é¸
            function resetPnLFilter() {
                document.getElementById('pnlStartDate').value = '';
                document.getElementById('pnlEndDate').value = '';
                renderRealizedPnL(null); // æ¢å¾©é¡¯ç¤ºå…¨éƒ¨
            }

            // æ¸²æŸ“å·²å¯¦ç¾æç›Šæ˜ç´°è¡¨æ ¼
            function renderPnLTable(data) {
                const container = document.getElementById('pnlTableContainer');

                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">æ—¥æœŸ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">å¸‚å ´</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨ä»£è™Ÿ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨åç¨±</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">è³£å‡ºè‚¡æ•¸</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ç¸½æˆæœ¬</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">è³£å‡ºç¸½åƒ¹</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å·²å¯¦ç¾æç›Š</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å ±é…¬ç‡%</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach((item, index) => {
                    // Update: Support new column keys (å°å¹£)
                    // If TWD columns exist, use them. Fallback to old keys only if TWD missing (backwards compat)
                    const isForeign = item['å¹£åˆ¥'] && item['å¹£åˆ¥'] !== 'TWD';

                    const qty = parseMoney(item['è³£å‡ºè‚¡æ•¸']);
                    // TWD Values
                    const costTWD = parseMoney(item['ç¸½æˆæœ¬(å°å¹£)'] || item['ç¸½æˆæœ¬']);
                    const saleTWD = parseMoney(item['è³£å‡ºåƒ¹(å°å¹£)'] || item['è³£å‡ºåƒ¹']);
                    const pnlTWD = parseMoney(item['å·²å¯¦ç¾æç›Š(å°å¹£)'] || item['å·²å¯¦ç¾æç›Š']);

                    // Original Values (for display if foreign)
                    const costOrig = parseMoney(item['ç¸½æˆæœ¬(åŸå¹£)']);
                    const saleOrig = parseMoney(item['è³£å‡ºåƒ¹(åŸå¹£)']);
                    const pnlOrig = parseMoney(item['å·²å¯¦ç¾æç›Š(åŸå¹£)']);

                    const pnlColor = pnlTWD >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                    const returnRate = parseMoney(item['å ±é…¬ç‡%']);
                    const returnColor = returnRate >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                    // Helper to show original currency if foreign
                    const showOrig = (val, symbol = '$') => isForeign ? `<div style="font-size:0.8em; opacity:0.7; margin-top:2px;">(${symbol}${val.toLocaleString()})</div>` : '';

                    tableHTML += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['æ—¥æœŸ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['å¸‚å ´'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['è‚¡ç¥¨ä»£è™Ÿ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.1);">${item['è‚¡ç¥¨åç¨±'] || '-'}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">${qty.toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">
                                $${costTWD.toLocaleString()}
                                ${showOrig(costOrig)}
                            </td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1);">
                                $${saleTWD.toLocaleString()}
                                ${showOrig(saleOrig)}
                            </td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1); color: ${pnlColor}; font-weight: 600;">
                                ${pnlTWD >= 0 ? '+' : ''}$${pnlTWD.toLocaleString()}
                                ${isForeign ? `<div style="font-size:0.8em; opacity:0.7; margin-top:2px; color:${pnlOrig >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">(${pnlOrig >= 0 ? '+' : ''}${pnlOrig.toLocaleString()})</div>` : ''}
                            </td>
                            <td style="padding: 10px; text-align: right; border: 1px solid rgba(255,255,255,0.1); color: ${returnColor}; font-weight: 600;">
                                ${returnRate >= 0 ? '+' : ''}${returnRate.toFixed(2)}%
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;
            }

            // åˆ†é åˆ‡æ›é‚è¼¯
            function openTab(tabName) {
                // éš±è—æ‰€æœ‰ tab-content
                const contents = document.getElementsByClassName("tab-content");
                for (let i = 0; i < contents.length; i++) {
                    contents[i].classList.remove("active");
                }

                // ç§»é™¤æ‰€æœ‰ tab-btn çš„ active æ¨£å¼
                const buttons = document.getElementsByClassName("tab-btn");
                for (let i = 0; i < buttons.length; i++) {
                    buttons[i].classList.remove("active");
                }

                // é¡¯ç¤ºç•¶å‰ tab-content ä¸¦å°‡æŒ‰éˆ•è¨­ç‚º active
                document.getElementById(tabName).classList.add("active");

                // æ‰¾å‡ºé»æ“Šçš„æŒ‰éˆ•ä¸¦è¨­ç‚º active
                const buttonsArray = Array.from(buttons);
                const clickedBtn = buttonsArray.find(btn => btn.getAttribute('onclick').includes(tabName));
                if (clickedBtn) clickedBtn.classList.add("active");
            }
        </script>
</body>

</html>