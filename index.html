<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人資產視覺化儀表板</title>
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <!-- 引入 ChartDataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- 引入 CountUp.js (數字捲動特效) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.0.7/countUp.min.js"></script>
    <!-- 引入 Google Fonts: Noto Sans TC (內文) + Roboto Mono (數字) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- 引入自訂樣式 -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <div class="container">
        <header>
            <h1>個人資產視覺化儀表板</h1>
            <p>輕鬆追蹤銀行資產、股票庫存與投資損益</p>
        </header>

        <!-- 檔案上傳區 -->
        <div class="upload-section">
            <!-- 拖放區域 -->
            <div id="dropZone" class="drop-zone">
                <div style="font-size: 3rem; margin-bottom: 10px;">📂</div>
                <h3 style="font-size: 1.5rem; margin-bottom: 10px;">拖曳所有 CSV 檔案至此</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">或點擊下方按鈕選擇檔案</p>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="document.getElementById('batchUpload').click()" class="action-btn primary"
                        style="background: var(--accent-color); color: #1e293b; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        🚀 選擇檔案
                    </button>
                    <button onclick="clearAllData()" class="action-btn danger"
                        style="background: var(--danger-color); color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        🗑️ 清除
                    </button>
                </div>

                <input type="file" id="batchUpload" accept=".csv" multiple style="display: none;">
                <div id="batchUploadStatus" style="margin-top: 15px; color: var(--text-main); font-weight: 500;"></div>
            </div>

            <!-- 個別上傳 Grid -->
            <div class="upload-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <div class="upload-item">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">🏦 銀行資產 <span
                            id="bankStatus" style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn"
                        style="display: block; padding: 8px; border: 1px dashed var(--glass-border); border-radius: 8px; text-align: center; cursor: pointer; color: var(--text-main); background: rgba(255,255,255,0.05);">
                        選擇檔案
                        <input type="file" id="bankFile" accept=".csv" onchange="handleFileUpload(event, 'bankAssets')"
                            style="display: none;">
                    </label>
                </div>
                <div class="upload-item">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">📈 股票庫存 <span
                            id="stockStatus" style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn"
                        style="display: block; padding: 8px; border: 1px dashed var(--glass-border); border-radius: 8px; text-align: center; cursor: pointer; color: var(--text-main); background: rgba(255,255,255,0.05);">
                        選擇檔案
                        <input type="file" id="stockFile" accept=".csv"
                            onchange="handleFileUpload(event, 'stockHoldings')" style="display: none;">
                    </label>
                </div>
                <div class="upload-item">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">💸 已實現損益 <span
                            id="pnlStatus" style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn"
                        style="display: block; padding: 8px; border: 1px dashed var(--glass-border); border-radius: 8px; text-align: center; cursor: pointer; color: var(--text-main); background: rgba(255,255,255,0.05);">
                        選擇檔案
                        <input type="file" id="pnlFile" accept=".csv" onchange="handleFileUpload(event, 'realizedPnL')"
                            style="display: none;">
                    </label>
                </div>
                <div class="upload-item">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">📝 交易明細 <span
                            id="transStatus" style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <label class="custom-file-btn"
                        style="display: block; padding: 8px; border: 1px dashed var(--glass-border); border-radius: 8px; text-align: center; cursor: pointer; color: var(--text-main); background: rgba(255,255,255,0.05);">
                        選擇檔案
                        <input type="file" id="transFile" accept=".csv"
                            onchange="handleFileUpload(event, 'transactions')" style="display: none;">
                    </label>
                </div>
            </div>
        </div>

        <!-- 導覽列 -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('assets')">個人資產</button>
            <button class="tab-btn" onclick="openTab('stocks')">股票庫存</button>
            <button class="tab-btn" onclick="openTab('pnl')">已實現損益</button>
            <button class="tab-btn" onclick="openTab('history')">交易歷史</button>
        </div>

        <!-- 1. 個人資產分頁 -->
        <div id="assets" class="tab-content active">
            <!-- 日期選擇器 -->
            <div class="dashboard-card"
                style="padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                <label for="bankDateSelect" style="font-weight: bold; color: var(--text-main);">📅 選擇日期:</label>
                <select id="bankDateSelect" onchange="renderBankAssets(this.value)"
                    style="padding: 8px 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; cursor: pointer; background-color: white;">
                    <option value="">(請先匯入資料)</option>
                </select>
            </div>

            <!-- 總資產卡片 -->
            <div id="bankAssetsCard" class="dashboard-card is-loading" style="text-align: center;">
                <h2 style="color: var(--text-main); font-size: 2rem; margin-bottom: 10px;">總資產</h2>

                <!-- Skeleton Loader -->
                <div class="skeleton-loader">
                    <div class="skeleton"
                        style="width: 200px; height: 3.5rem; margin: 0 auto 10px; border-radius: 8px;"></div>
                    <div class="skeleton" style="width: 300px; height: 60px; margin: 10px auto; border-radius: 8px;">
                    </div>
                    <div class="skeleton" style="width: 150px; height: 1em; margin: 10px auto 0; border-radius: 4px;">
                    </div>
                </div>

                <!-- Content Ready -->
                <div class="content-ready">
                    <div id="totalBankAssets" style="font-size: 3rem; font-weight: 700; color: var(--accent-color);">
                        $0
                    </div>
                    <!-- Sparkline Container -->
                    <div style="height: 60px; width: 100%; margin: 10px auto; max-width: 300px;">
                        <canvas id="totalAssetSparkline"></canvas>
                    </div>
                    <div id="assetsDate" style="color: var(--text-secondary); margin-top: 5px; font-size: 0.9rem;">
                        (尚未載入資料)
                    </div>
                </div>
            </div>

            <!-- 圖表卡片 -->
            <div class="dashboard-card">
                <h2 class="section-title">資產分佈</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="bankPieChart"></canvas>
                </div>
            </div>

            <!-- 帳戶明細表格 -->
            <div class="dashboard-card">
                <h2 class="section-title">帳戶明細</h2>
                <div id="bankTableContainer">
                    <div class="placeholder-text">
                        請上傳銀行資產 CSV 檔案以檢視明細
                    </div>
                </div>
            </div>

            <!-- 圖表卡片: 資產趨勢圖 -->
            <div class="dashboard-card">
                <h2 class="section-title">資產趨勢圖</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="assetTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 2. 股票庫存分頁 -->
        <div id="stocks" class="tab-content">
            <!-- 日期選擇器 -->
            <div class="dashboard-card"
                style="padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                <label for="stockDateSelect" style="font-weight: bold; color: var(--text-main);">📅 選擇日期:</label>
                <select id="stockDateSelect" onchange="renderStockHoldings(this.value)"
                    style="padding: 8px 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; cursor: pointer; background-color: white;">
                    <option value="">(請先匯入資料)</option>
                </select>
            </div>

            <!-- 總市值與損益卡片 -->
            <div class="dashboard-card" style="text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h2 style="color: var(--text-main); font-size: 2rem; margin-bottom: 10px;">總市值</h2>
                        <div id="totalMarketValue"
                            style="font-size: 3rem; font-weight: 700; color: var(--accent-color);">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-main); font-size: 2rem; margin-bottom: 10px;">未實現損益</h2>
                        <div id="totalUnrealizedPnL" style="font-size: 3rem; font-weight: 700;">
                            $0
                        </div>
                    </div>
                </div>
                <div id="stockDate" style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">
                    (尚未載入資料)
                </div>
            </div>

            <!-- 圖表卡片: 持股分佈 -->
            <div class="dashboard-card">
                <h2 class="section-title">持股分佈 (依市值)</h2>
                <div class="chart-container" style="height: 400px; position: relative;">
                    <!-- Chart Switcher -->
                    <div style="position: absolute; top: 0; right: 0; z-index: 10; display: flex; gap: 5px;">
                        <button onclick="switchStockChart('pie')" id="btn-chart-pie" class="action-btn primary"
                            style="padding: 5px 12px; font-size: 0.9rem; font-weight: bold; background: var(--accent-color); color: #1e293b; border: none; border-radius: 6px; cursor: pointer;">圓餅圖</button>
                        <button onclick="switchStockChart('bar')" id="btn-chart-bar" class="action-btn"
                            style="padding: 5px 12px; font-size: 0.9rem; font-weight: bold; background: rgba(255,255,255,0.1); color: var(--text-main); border: none; border-radius: 6px; cursor: pointer;">長條圖</button>
                        <button onclick="switchStockChart('bubble')" id="btn-chart-bubble" class="action-btn"
                            style="padding: 5px 12px; font-size: 0.9rem; font-weight: bold; background: rgba(255,255,255,0.1); color: var(--text-main); border: none; border-radius: 6px; cursor: pointer;">氣泡圖</button>
                    </div>
                    <canvas id="stockPieChart"></canvas>
                </div>
            </div>

            <!-- 持股明細表格 -->
            <div class="dashboard-card">
                <h2 class="section-title">持股明細</h2>
                <div id="stockTableContainer">
                    <div class="placeholder-text">
                        請上傳股票庫存 CSV 檔案以檢視明細
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 已實現損益分頁 -->
        <div id="pnl" class="tab-content">
            <!-- 篩選器區域 -->
            <div class="dashboard-card" style="margin-bottom: 20px; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="font-weight: bold; color: var(--text-secondary);">📅 日期篩選:</div>
                    <input type="date" id="pnlStartDate"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <span>至</span>
                    <input type="date" id="pnlEndDate"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">

                    <button onclick="applyPnLFilter()"
                        style="background: var(--accent-color); color: #1e293b; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                        🔍 篩選
                    </button>
                    <button onclick="resetPnLFilter()"
                        style="background: #f1f5f9; color: var(--text-secondary); border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        🔄 重置
                    </button>
                </div>
            </div>

            <!-- 總損益卡片 -->
            <div class="dashboard-card" style="text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <h2 style="color: var(--text-main); font-size: 2rem; margin-bottom: 10px;">總已實現損益</h2>
                        <div id="totalRealizedPnL" style="font-size: 3rem; font-weight: 700;">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-main); font-size: 2rem; margin-bottom: 10px;">總賣出價</h2>
                        <div id="totalSalePrice" style="font-size: 3rem; font-weight: 700; color: var(--accent-color);">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-main); font-size: 2rem; margin-bottom: 10px;">總成本</h2>
                        <div id="totalCost" style="font-size: 3rem; font-weight: 700; color: var(--text-secondary);">
                            $0
                        </div>
                    </div>
                </div>
                <div id="pnlDate" style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">
                    (尚未載入資料)
                </div>
            </div>

            <!-- 圖表卡片: 損益分佈 -->
            <div class="dashboard-card">
                <h2 class="section-title">損益分佈 (盈利 vs 虧損)</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="pnlPieChart"></canvas>
                </div>
            </div>

            <!-- 交易明細表格 -->
            <div class="dashboard-card">
                <h2 class="section-title">交易明細</h2>
                <div id="pnlTableContainer">
                    <div class="placeholder-text">
                        請上傳已實現損益 CSV 檔案以檢視明細
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 交易歷史分頁 -->
        <div id="history" class="tab-content">
            <div class="dashboard-card">
                <h2 class="section-title">交易歷史流水帳</h2>
                <div id="historyTableContainer">
                    <div class="placeholder-text">
                        請上傳交易明細 CSV 檔案以檢視內容
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 引入應用程式邏輯 -->
    <script src="js/app.js"></script>
</body>

</html>