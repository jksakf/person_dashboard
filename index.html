<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè³‡ç”¢è¦–è¦ºåŒ–å„€è¡¨æ¿</title>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <!-- å¼•å…¥ ChartDataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Ns+Jansong:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #2d3748;
            --text-secondary: #262842;
            --accent-color: #667eea;
            --success-color: #48bb78;
            --danger-color: #f56565;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            color: var(--text-main);
            padding: 20px;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header Section */
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header p {
            opacity: 0.9;
            font-weight: 300;
        }

        /* File Upload Section */
        .upload-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .upload-item {
            display: flex;
            flex-direction: column;
        }

        .upload-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .upload-item input[type="file"] {
            padding: 10px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-item input[type="file"]:hover {
            border-color: var(--accent-color);
            background-color: #f7fafc;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-btn {
            padding: 12px 30px;
            border: none;
            background: transparent;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .tab-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: white;
            color: var(--accent-color);
            opacity: 1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Content Sections */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--text-main);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #edf2f7;
        }

        /* Placeholder Styles */
        .placeholder-text {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .tabs {
                flex-direction: column;
                width: 100%;
                background: transparent;
                padding: 0;
            }

            .tab-btn {
                margin-bottom: 10px;
                background: rgba(255, 255, 255, 0.2);
                width: 100%;
            }

            .tab-btn.active {
                background: white;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>å€‹äººè³‡ç”¢è¦–è¦ºåŒ–å„€è¡¨æ¿</h1>
            <p>è¼•é¬†è¿½è¹¤éŠ€è¡Œè³‡ç”¢ã€è‚¡ç¥¨åº«å­˜èˆ‡æŠ•è³‡æç›Š</p>
        </header>

        <!-- æª”æ¡ˆä¸Šå‚³å€ -->
        <div class="upload-section">
            <!-- ä¸€éµè¼‰å…¥æŒ‰éˆ• -->
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="document.getElementById('batchUpload').click()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                               color: white; 
                               border: none; 
                               padding: 12px 30px; 
                               border-radius: 8px; 
                               font-size: 1.1rem; 
                               font-weight: 600; 
                               cursor: pointer; 
                               box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                               transition: transform 0.2s, box-shadow 0.2s;">
                    ğŸš€ ä¸€éµè¼‰å…¥å…¨éƒ¨ CSV
                </button>
                <input type="file" id="batchUpload" accept=".csv" multiple style="display: none;">
                <div id="batchUploadStatus" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;">
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0; color: var(--text-secondary); font-size: 0.9rem;">
                æˆ–å€‹åˆ¥ä¸Šå‚³ â†“
            </div>

            <!-- å€‹åˆ¥ä¸Šå‚³ -->
            <div class="upload-grid">
                <div class="upload-item">
                    <label>ğŸ¦ åŒ¯å…¥éŠ€è¡Œè³‡ç”¢ CSV <span id="bankStatus"
                            style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <input type="file" id="bankFile" accept=".csv" onchange="handleFileUpload(event, 'bankAssets')">
                </div>
                <div class="upload-item">
                    <label>ğŸ“ˆ åŒ¯å…¥è‚¡ç¥¨åº«å­˜ CSV <span id="stockStatus"
                            style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <input type="file" id="stockFile" accept=".csv" onchange="handleFileUpload(event, 'stockHoldings')">
                </div>
                <div class="upload-item">
                    <label>ğŸ’¸ åŒ¯å…¥å·²å¯¦ç¾æç›Š CSV <span id="pnlStatus"
                            style="font-size:0.8em; color:var(--success-color)"></span></label>
                    <input type="file" id="pnlFile" accept=".csv" onchange="handleFileUpload(event, 'realizedPnL')">
                </div>
            </div>
        </div>

        <!-- å°è¦½åˆ— -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('assets')">å€‹äººè³‡ç”¢</button>
            <button class="tab-btn" onclick="openTab('stocks')">è‚¡ç¥¨åº«å­˜</button>
            <button class="tab-btn" onclick="openTab('pnl')">å·²å¯¦ç¾æç›Š</button>
        </div>

        <!-- 1. å€‹äººè³‡ç”¢åˆ†é  -->
        <div id="assets" class="tab-content active">
            <!-- ç¸½è³‡ç”¢å¡ç‰‡ -->
            <div class="dashboard-card" style="text-align: center;">
                <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½è³‡ç”¢</h2>
                <div id="totalBankAssets" style="font-size: 3rem; font-weight: 700; color: var(--accent-color);">
                    $0
                </div>
                <div id="assetsDate" style="color: var(--text-secondary); margin-top: 5px; font-size: 0.9rem;">
                    (å°šæœªè¼‰å…¥è³‡æ–™)
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡ -->
            <div class="dashboard-card">
                <h2 class="section-title">è³‡ç”¢åˆ†ä½ˆ</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="bankPieChart"></canvas>
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡: è³‡ç”¢è¶¨å‹¢åœ– -->
            <div class="dashboard-card">
                <h2 class="section-title">è³‡ç”¢è¶¨å‹¢åœ–</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="assetTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 2. è‚¡ç¥¨åº«å­˜åˆ†é  -->
        <div id="stocks" class="tab-content">
            <!-- ç¸½å¸‚å€¼èˆ‡æç›Šå¡ç‰‡ -->
            <div class="dashboard-card" style="text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½å¸‚å€¼</h2>
                        <div id="totalMarketValue"
                            style="font-size: 2.5rem; font-weight: 700; color: var(--accent-color);">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">æœªå¯¦ç¾æç›Š</h2>
                        <div id="totalUnrealizedPnL" style="font-size: 2.5rem; font-weight: 700;">
                            $0
                        </div>
                    </div>
                </div>
                <div id="stockDate" style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">
                    (å°šæœªè¼‰å…¥è³‡æ–™)
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡: æŒè‚¡åˆ†ä½ˆ -->
            <div class="dashboard-card">
                <h2 class="section-title">æŒè‚¡åˆ†ä½ˆ (ä¾å¸‚å€¼)</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="stockPieChart"></canvas>
                </div>
            </div>

            <!-- æŒè‚¡æ˜ç´°è¡¨æ ¼ -->
            <div class="dashboard-card">
                <h2 class="section-title">æŒè‚¡æ˜ç´°</h2>
                <div id="stockTableContainer" style="overflow-x: auto;">
                    <div class="placeholder-text">
                        è«‹ä¸Šå‚³è‚¡ç¥¨åº«å­˜ CSV æª”æ¡ˆä»¥æª¢è¦–æ˜ç´°
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. å·²å¯¦ç¾æç›Šåˆ†é  -->
        <div id="pnl" class="tab-content">
            <!-- ç¸½æç›Šå¡ç‰‡ -->
            <div class="dashboard-card" style="text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½å·²å¯¦ç¾æç›Š</h2>
                        <div id="totalRealizedPnL" style="font-size: 2.5rem; font-weight: 700;">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½è³£å‡ºåƒ¹</h2>
                        <div id="totalSalePrice"
                            style="font-size: 2.5rem; font-weight: 700; color: var(--accent-color);">
                            $0
                        </div>
                    </div>
                    <div>
                        <h2 style="color: var(--text-secondary); font-size: 2rem; margin-bottom: 10px;">ç¸½æˆæœ¬</h2>
                        <div id="totalCost" style="font-size: 2.5rem; font-weight: 700; color: var(--text-secondary);">
                            $0
                        </div>
                    </div>
                </div>
                <div id="pnlDate" style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">
                    (å°šæœªè¼‰å…¥è³‡æ–™)
                </div>
            </div>

            <!-- åœ–è¡¨å¡ç‰‡: æç›Šåˆ†ä½ˆ -->
            <div class="dashboard-card">
                <h2 class="section-title">æç›Šåˆ†ä½ˆ (ç›ˆåˆ© vs è™§æ)</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="pnlPieChart"></canvas>
                </div>
            </div>

            <!-- äº¤æ˜“æ˜ç´°è¡¨æ ¼ -->
            <div class="dashboard-card">
                <h2 class="section-title">äº¤æ˜“æ˜ç´°</h2>
                <div id="pnlTableContainer" style="overflow-x: auto;">
                    <div class="placeholder-text">
                        è«‹ä¸Šå‚³å·²å¯¦ç¾æç›Š CSV æª”æ¡ˆä»¥æª¢è¦–æ˜ç´°
                    </div>
                </div>
            </div>
        </div>

        <script>
            // 0. å…¨åŸŸéŒ¯èª¤æ””æˆª (Nuclear Option)
            window.onerror = function (message, source, lineno, colno, error) {
                alert(`ğŸš¨ ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤:\n\nè¨Šæ¯: ${message}\nè¡Œè™Ÿ: ${lineno}\nä¾†æº: ${source}\n\nè«‹æˆªåœ–æ­¤ç•«é¢å›å ±ã€‚`);
                return false;
            };

            // 1. æª¢æŸ¥ç›¸ä¾å¥—ä»¶æ˜¯å¦è¼‰å…¥
            window.onload = function () {
                let missing = [];
                if (typeof Papa === 'undefined') missing.push("PapaParse (è®€å– CSV ç”¨)");
                if (typeof Chart === 'undefined') missing.push("Chart.js (ç•«åœ–ç”¨)");

                if (missing.length > 0) {
                    alert(`âŒ åš´é‡éŒ¯èª¤ï¼šç¼ºå°‘å¿…è¦å…ƒä»¶ï¼\n\n${missing.join('\n')}\n\nå¯èƒ½æ˜¯ç¶²è·¯å•é¡Œå°è‡´ç„¡æ³•è¼‰å…¥ CDNï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚`);
                } else {
                    console.log("âœ… æ‰€æœ‰å…ƒä»¶è¼‰å…¥æˆåŠŸ");
                }
            }

            // æ‰¹æ¬¡ä¸Šå‚³è™•ç†
            function handleBatchUpload(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                const statusEl = document.getElementById('batchUploadStatus');
                statusEl.textContent = `â³ æ­£åœ¨è™•ç† ${files.length} å€‹æª”æ¡ˆ...`;

                let processed = 0;
                let success = 0;
                const results = [];

                files.forEach(file => {
                    const fileName = file.name.toLowerCase();
                    let targetType = null;
                    let targetInput = null;

                    // æ ¹æ“šæª”ååˆ¤æ–·é¡å‹
                    if (fileName.includes('bank_asset')) {
                        targetType = 'bankAssets';
                        targetInput = document.getElementById('bankFile');
                    } else if (fileName.includes('stock_holding')) {
                        targetType = 'stockHoldings';
                        targetInput = document.getElementById('stockFile');
                    } else if (fileName.includes('realized_pnl')) {
                        targetType = 'realizedPnL';
                        targetInput = document.getElementById('pnlFile');
                    }

                    if (targetType && targetInput) {
                        // å»ºç«‹è™›æ“¬äº‹ä»¶ä¸¦å‘¼å«åŸæœ‰çš„è™•ç†å‡½å¼
                        const fakeEvent = {
                            target: {
                                files: [file],
                                value: file.name
                            }
                        };

                        try {
                            handleFileUpload(fakeEvent, targetType);
                            results.push(`âœ… ${file.name}`);
                            success++;
                        } catch (err) {
                            results.push(`âŒ ${file.name}: ${err.message}`);
                        }
                    } else {
                        results.push(`âš ï¸ ${file.name}: ç„¡æ³•è­˜åˆ¥æª”æ¡ˆé¡å‹`);
                    }

                    processed++;

                    // å…¨éƒ¨è™•ç†å®Œæˆå¾Œæ›´æ–°ç‹€æ…‹
                    if (processed === files.length) {
                        setTimeout(() => {
                            statusEl.innerHTML = `
                                <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                                    <strong>è™•ç†å®Œæˆï¼š${success}/${files.length} å€‹æª”æ¡ˆæˆåŠŸè¼‰å…¥</strong><br>
                                    ${results.join('<br>')}
                                </div>
                            `;
                        }, 500);
                    }
                });
            }

            // ä¸€éµè¼‰å…¥äº‹ä»¶ç›£è½
            document.getElementById('batchUpload').addEventListener('change', handleBatchUpload);

            // å…¨åŸŸè³‡æ–™å„²å­˜ç‰©ä»¶
            let appData = {
                bankAssets: [],
                stockHoldings: [],
                realizedPnL: []
            };

            let charts = {}; // å„²å­˜åœ–è¡¨å¯¦ä¾‹

            // è‹¥ ChartDataLabels æ’ä»¶æœ‰è¼‰å…¥ï¼Œå‰‡è¨»å†Šå®ƒ
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
                // è¨­å®šé è¨­å…¨åŸŸè¨­å®šï¼Œé¿å…å½±éŸ¿å…¶ä»–åœ–è¡¨ (ä¹Ÿå¯åœ¨å€‹åˆ¥åœ–è¡¨è¨­å®š)
                Chart.defaults.set('plugins.datalabels', {
                    display: false // é è¨­ä¸é¡¯ç¤ºï¼Œé™¤éå€‹åˆ¥ chart é–‹å•Ÿ
                });
            }

            // CSV æ¬„ä½å®šç¾© (ç”¨æ–¼é©—è­‰æª”æ¡ˆé¡å‹)
            const SCHEMA = {
                bankAssets: ["æ—¥æœŸ", "å¸³æˆ¶åç¨±", "é‡‘é¡"],
                stockHoldings: ["æ—¥æœŸ", "å¸‚å ´", "è‚¡ç¥¨ä»£è™Ÿ", "è‚¡ç¥¨åç¨±", "æŒæœ‰è‚¡æ•¸", "ç¸½æˆæœ¬", "ç¸½å¸‚å€¼", "æœªå¯¦ç¾æç›Š", "å ±é…¬ç‡%"],
                realizedPnL: ["æ—¥æœŸ", "å¸‚å ´", "è‚¡ç¥¨ä»£è™Ÿ", "è‚¡ç¥¨åç¨±", "è³£å‡ºè‚¡æ•¸", "ç¸½æˆæœ¬", "è³£å‡ºåƒ¹", "å·²å¯¦ç¾æç›Š", "å ±é…¬ç‡%"]
            };

            // è¼”åŠ©å‡½å¼ï¼šè§£æé‡‘é¡ (è™•ç† "1,000" å­—ä¸²æˆ–æ•¸å­—)
            function parseMoney(value) {
                if (typeof value === 'number') return value;
                if (typeof value === 'string') {
                    // ç§»é™¤é€—è™Ÿå¾Œè½‰æ•¸å­—
                    const cleanStr = value.replace(/,/g, '').trim();
                    return parseFloat(cleanStr) || 0;
                }
                return 0;
            }

            // è™•ç†æª”æ¡ˆä¸Šå‚³
            function handleFileUpload(event, type) {
                try {
                    // æª¢æŸ¥ Library æ˜¯å¦å­˜åœ¨
                    if (typeof Papa === 'undefined') {
                        throw new Error("PapaParse å…ƒä»¶æœªè¼‰å…¥ï¼Œç„¡æ³•è®€å– CSV");
                    }

                    const file = event.target.files[0];
                    if (!file) return;

                    const statusId = type === 'bankAssets' ? 'bankStatus' :
                        type === 'stockHoldings' ? 'stockStatus' : 'pnlStatus';
                    const statusEl = document.getElementById(statusId);

                    statusEl.textContent = "â³ è®€å–ä¸­...";

                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        // encoding: "UTF-8", // ç§»é™¤å¼·åˆ¶ç·¨ç¢¼
                        dynamicTyping: true,
                        complete: function (results) {
                            try {
                                console.log("Parsing complete for", type, results);
                                const data = results.data;
                                const meta = results.meta;

                                if (!data || data.length === 0) {
                                    throw new Error("CSV æª”æ¡ˆå…§å®¹ç‚ºç©º");
                                }

                                // æª¢æŸ¥ meta.fields æ˜¯å¦å­˜åœ¨
                                if (!meta.fields) {
                                    throw new Error("ç„¡æ³•è®€å– CSV æ¬„ä½ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼");
                                }

                                // 1. æ¬„ä½é©—è­‰ (ä¿®æ­£ BOM)
                                const requiredFields = SCHEMA[type];
                                // ç§»é™¤ BOM ä¸¦å»é™¤ç©ºç™½
                                const fileFields = meta.fields.map(f => typeof f === 'string' ? f.replace(/^\ufeff/, '').trim() : f);

                                const isValid = requiredFields.every(field => fileFields.includes(field));

                                if (!isValid) {
                                    alert(`âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼\nç¼ºå°‘æ¬„ä½: ${requiredFields.filter(f => !fileFields.includes(f)).join(', ')}\nè®€åˆ°çš„æ¬„ä½: ${fileFields.join(', ')}`);
                                    event.target.value = "";
                                    statusEl.textContent = "";
                                    return;
                                }

                                // 2. æ¸…æ´—è³‡æ–™ Key (ç§»é™¤ BOM)
                                const cleanData = data.map(row => {
                                    const newRow = {};
                                    Object.keys(row).forEach(key => {
                                        // ç¢ºä¿ key æ˜¯å­—ä¸²æ‰è™•ç†
                                        const cleanKey = typeof key === 'string' ? key.replace(/^\ufeff/, '').trim() : key;
                                        newRow[cleanKey] = row[key];
                                    });
                                    return newRow;
                                });

                                appData[type] = cleanData;
                                console.log(`âœ… [${type}] Loaded ${cleanData.length} records`);

                                // 3. æ›´æ–°ç‹€æ…‹é¡¯ç¤º (å…ˆæ›´æ–°æ–‡å­—ï¼Œå†ç•«åœ–)
                                statusEl.textContent = `âœ… å·²è¼‰å…¥ ${cleanData.length} ç­†`;

                                // 4. è§¸ç™¼åœ–è¡¨æ›´æ–°
                                if (type === 'bankAssets') {
                                    setTimeout(() => { // ç¨å¾®å»¶é²è®“ UI æ›´æ–°
                                        try {
                                            renderBankAssets();
                                            renderAssetTrend();
                                        } catch (renderErr) {
                                            console.error("Render Error:", renderErr);
                                            alert("åœ–è¡¨ç¹ªè£½å¤±æ•—: " + renderErr.message);
                                        }
                                    }, 50);
                                } else if (type === 'stockHoldings') {
                                    setTimeout(() => {
                                        try {
                                            renderStockHoldings();
                                        } catch (renderErr) {
                                            console.error("Render Error:", renderErr);
                                            alert("åœ–è¡¨ç¹ªè£½å¤±æ•—: " + renderErr.message);
                                        }
                                    }, 50);
                                } else if (type === 'realizedPnL') {
                                    setTimeout(() => {
                                        try {
                                            renderRealizedPnL();
                                        } catch (renderErr) {
                                            console.error("Render Error:", renderErr);
                                            alert("åœ–è¡¨ç¹ªè£½å¤±æ•—: " + renderErr.message);
                                        }
                                    }, 50);
                                }
                            } catch (err) {
                                console.error("Processing Error:", err);
                                alert("âŒ è³‡æ–™è™•ç†ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                                statusEl.textContent = "âŒ éŒ¯èª¤";
                            }
                        },
                        error: function (error) {
                            console.error("Error parsing CSV:", error);
                            alert("âŒ æª”æ¡ˆè§£æå¤±æ•—: " + error.message);
                            statusEl.textContent = "âŒ å¤±æ•—";
                        }
                    });
                } catch (e) {
                    console.error("Global Error in handleFileUpload:", e);
                    alert("ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: " + e.message);
                    if (document.getElementById(type === 'bankAssets' ? 'bankStatus' : type === 'stockHoldings' ? 'stockStatus' : 'pnlStatus')) {
                        document.getElementById(type === 'bankAssets' ? 'bankStatus' : type === 'stockHoldings' ? 'stockStatus' : 'pnlStatus').textContent = "âŒ éŒ¯èª¤";
                    }
                }
            }

            // æ¸²æŸ“éŠ€è¡Œè³‡ç”¢åœ“é¤…åœ– (æœ€æ–°æœˆä»½)
            function renderBankAssets() {
                const data = appData.bankAssets;
                if (!data || data.length === 0) return;

                // 1. æ‰¾å‡ºæœ€æ–°æ—¥æœŸ
                const uniqueDates = [...new Set(data.map(item => item['æ—¥æœŸ']))].sort().reverse();
                const latestDate = uniqueDates[0];

                // 2. éæ¿¾æœ€æ–°æ—¥æœŸçš„è³‡æ–™
                const currentData = data.filter(item => item['æ—¥æœŸ'] === latestDate);

                // 3. è¨ˆç®—ç¸½é‡‘é¡
                const totalAmount = currentData.reduce((sum, item) => sum + parseMoney(item['é‡‘é¡']), 0);

                // 4. æ›´æ–° DOM
                document.getElementById('totalBankAssets').textContent = `$${totalAmount.toLocaleString()}`;
                document.getElementById('assetsDate').textContent = `è³‡æ–™æ—¥æœŸ: ${latestDate}`;

                // 5. æº–å‚™åœ–è¡¨è³‡æ–™
                const labels = currentData.map(item => item['å¸³æˆ¶åç¨±']);
                const amounts = currentData.map(item => parseMoney(item['é‡‘é¡']));

                // 6. ç¹ªè£½åœ“é¤…åœ–
                const ctx = document.getElementById('bankPieChart').getContext('2d');

                if (charts['bankPie']) {
                    charts['bankPie'].destroy();
                }

                charts['bankPie'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: amounts,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#FF5733', '#33FF57', '#3357FF', '#F333FF'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 16
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18 // æ”¾å¤§ Tooltip æ¨™é¡Œ
                                },
                                bodyFont: {
                                    size: 18 // æ”¾å¤§ Tooltip å…§å®¹
                                },
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw;
                                        const percentage = ((value / totalAmount) * 100).toFixed(1) + '%';
                                        label += `$${value.toLocaleString()} (${percentage})`;
                                        return label;
                                    }
                                }
                            },
                            // è¨­å®š datalabels (ç›´æ¥é¡¯ç¤ºåœ¨åœ–ä¸Š)
                            datalabels: {
                                display: true, // å¼·åˆ¶é¡¯ç¤º
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 16 // æ”¾å¤§åœ“é¤…åœ–ä¸Šçš„æ–‡å­—
                                },
                                formatter: function (value, context) {
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const percentage = ((value / totalAmount) * 100).toFixed(1) + '%';
                                    // å¦‚æœæ¯”ä¾‹å¤ªå° (<5%) å°±ä¸é¡¯ç¤ºï¼Œé¿å…æ“ åœ¨ä¸€èµ·
                                    if ((value / totalAmount) < 0.05) return null;
                                    return label + '\n' + percentage;
                                },
                                textAlign: 'center'
                            }
                        }
                    }
                });
            }

            // æ¸²æŸ“è³‡ç”¢æ­·å²è¶¨å‹¢åœ– (æŠ˜ç·šåœ–)
            function renderAssetTrend() {
                const data = appData.bankAssets;
                if (!data || data.length === 0) return;

                // 1. æ•´ç†æ¯æ—¥ç¸½è³‡ç”¢
                let dailyTotals = {};
                data.forEach(item => {
                    const date = item['æ—¥æœŸ'];
                    const amount = parseMoney(item['é‡‘é¡']);
                    if (!dailyTotals[date]) {
                        dailyTotals[date] = 0;
                    }
                    dailyTotals[date] += amount;
                });

                // 2. æ’åºæ—¥æœŸ
                const sortedDates = Object.keys(dailyTotals).sort();
                const sortedAmounts = sortedDates.map(date => dailyTotals[date]);

                // 3. ç¹ªè£½æŠ˜ç·šåœ–
                const ctx = document.getElementById('assetTrendChart').getContext('2d');

                if (charts['assetTrend']) {
                    charts['assetTrend'].destroy();
                }

                charts['assetTrend'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'ç¸½è³‡ç”¢',
                            data: sortedAmounts,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#764ba2',
                            pointRadius: 5,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            datalabels: {
                                display: false // æŠ˜ç·šåœ–ä¸é¡¯ç¤º datalabels
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18 // æ”¾å¤§ Tooltip æ¨™é¡Œ
                                },
                                bodyFont: {
                                    size: 18 // æ”¾å¤§ Tooltip å…§å®¹
                                },
                                intersect: false,
                                mode: 'index',
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += '$' + context.parsed.y.toLocaleString();
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    callback: function (value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // æ¸²æŸ“è‚¡ç¥¨åº«å­˜ (åœ“é¤…åœ– + æ˜ç´°è¡¨)
            function renderStockHoldings() {
                const data = appData.stockHoldings;
                if (!data || data.length === 0) return;

                // 1. æ‰¾å‡ºæœ€æ–°æ—¥æœŸ
                const uniqueDates = [...new Set(data.map(item => item['æ—¥æœŸ']))].sort().reverse();
                const latestDate = uniqueDates[0];

                // 2. éæ¿¾æœ€æ–°æ—¥æœŸçš„è³‡æ–™
                const currentData = data.filter(item => item['æ—¥æœŸ'] === latestDate);

                // 3. è¨ˆç®—ç¸½å¸‚å€¼èˆ‡ç¸½æœªå¯¦ç¾æç›Š
                const totalMarketValue = currentData.reduce((sum, item) => sum + parseMoney(item['ç¸½å¸‚å€¼']), 0);
                const totalUnrealizedPnL = currentData.reduce((sum, item) => sum + parseMoney(item['æœªå¯¦ç¾æç›Š']), 0);

                // 4. æ›´æ–° DOM
                document.getElementById('totalMarketValue').textContent = `$${totalMarketValue.toLocaleString()}`;

                const pnlEl = document.getElementById('totalUnrealizedPnL');
                pnlEl.textContent = `$${totalUnrealizedPnL.toLocaleString()}`;
                pnlEl.style.color = totalUnrealizedPnL >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                document.getElementById('stockDate').textContent = `è³‡æ–™æ—¥æœŸ: ${latestDate}`;

                // 5. æº–å‚™åœ“é¤…åœ–è³‡æ–™
                const labels = currentData.map(item => item['è‚¡ç¥¨åç¨±'] || item['è‚¡ç¥¨ä»£è™Ÿ']);
                const marketValues = currentData.map(item => parseMoney(item['ç¸½å¸‚å€¼']));

                // 6. ç¹ªè£½åœ“é¤…åœ–
                const ctx = document.getElementById('stockPieChart').getContext('2d');

                if (charts['stockPie']) {
                    charts['stockPie'].destroy();
                }

                charts['stockPie'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: marketValues,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#FF5733', '#33FF57', '#3357FF', '#F333FF'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 14
                                    },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18
                                },
                                bodyFont: {
                                    size: 18
                                },
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw;
                                        const percentage = ((value / totalMarketValue) * 100).toFixed(1) + '%';
                                        label += `$${value.toLocaleString()} (${percentage})`;
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: function (value, context) {
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const percentage = ((value / totalMarketValue) * 100).toFixed(1) + '%';
                                    // å¦‚æœæ¯”ä¾‹å¤ªå° (<3%) å°±ä¸é¡¯ç¤º
                                    if ((value / totalMarketValue) < 0.03) return null;
                                    return label + '\n' + percentage;
                                },
                                textAlign: 'center'
                            }
                        }
                    }
                });

                // 7. ç¹ªè£½æ˜ç´°è¡¨æ ¼
                renderStockTable(currentData);
            }

            // æ¸²æŸ“æŒè‚¡æ˜ç´°è¡¨æ ¼
            function renderStockTable(data) {
                const container = document.getElementById('stockTableContainer');

                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">å¸‚å ´</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨ä»£è™Ÿ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨åç¨±</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">æŒæœ‰è‚¡æ•¸</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ç¸½æˆæœ¬</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ç¸½å¸‚å€¼</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">æœªå¯¦ç¾æç›Š</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å ±é…¬ç‡%</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach((item, index) => {
                    const bgColor = index % 2 === 0 ? '#f9f9f9' : '#fff';
                    const pnl = parseMoney(item['æœªå¯¦ç¾æç›Š']);
                    const pnlColor = pnl >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                    const returnRate = parseMoney(item['å ±é…¬ç‡%']);
                    const returnColor = returnRate >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                    tableHTML += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 10px; border: 1px solid #ddd;">${item['å¸‚å ´'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item['è‚¡ç¥¨ä»£è™Ÿ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item['è‚¡ç¥¨åç¨±'] || '-'}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${parseMoney(item['æŒæœ‰è‚¡æ•¸']).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">$${parseMoney(item['ç¸½æˆæœ¬']).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">$${parseMoney(item['ç¸½å¸‚å€¼']).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${pnlColor}; font-weight: 600;">
                                ${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString()}
                            </td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${returnColor}; font-weight: 600;">
                                ${returnRate >= 0 ? '+' : ''}${returnRate.toFixed(2)}%
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;
            }

            // æ¸²æŸ“å·²å¯¦ç¾æç›Š (åœ“é¤…åœ– + æ˜ç´°è¡¨)
            function renderRealizedPnL() {
                const data = appData.realizedPnL;
                if (!data || data.length === 0) return;

                // 1. ä½¿ç”¨æ‰€æœ‰è³‡æ–™ï¼ˆä¸éæ¿¾æ—¥æœŸï¼‰
                const allData = data;

                // 2. æ‰¾å‡ºè³‡æ–™æ—¥æœŸç¯„åœï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
                const uniqueDates = [...new Set(data.map(item => item['æ—¥æœŸ']))].sort();
                const dateRange = uniqueDates.length > 1
                    ? `${uniqueDates[0]} ~ ${uniqueDates[uniqueDates.length - 1]}`
                    : uniqueDates[0];

                // 3. è¨ˆç®—ç¸½å·²å¯¦ç¾æç›Šã€ç¸½è³£å‡ºåƒ¹ã€ç¸½æˆæœ¬
                const totalRealizedPnL = allData.reduce((sum, item) => sum + parseMoney(item['å·²å¯¦ç¾æç›Š']), 0);
                const totalSalePrice = allData.reduce((sum, item) => sum + parseMoney(item['è³£å‡ºåƒ¹']), 0);
                const totalCost = allData.reduce((sum, item) => sum + parseMoney(item['ç¸½æˆæœ¬']), 0);

                // 4. æ›´æ–° DOM
                const pnlEl = document.getElementById('totalRealizedPnL');
                pnlEl.textContent = `$${totalRealizedPnL.toLocaleString()}`;
                pnlEl.style.color = totalRealizedPnL >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                document.getElementById('totalSalePrice').textContent = `$${totalSalePrice.toLocaleString()}`;
                document.getElementById('totalCost').textContent = `$${totalCost.toLocaleString()}`;
                document.getElementById('pnlDate').textContent = `è³‡æ–™æœŸé–“: ${dateRange} (å…± ${allData.length} ç­†äº¤æ˜“)`;

                // 5. è¨ˆç®—ç›ˆåˆ©/è™§æäº¤æ˜“çš„é‡‘é¡
                let profitAmount = 0;
                let lossAmount = 0;

                allData.forEach(item => {
                    const pnl = parseMoney(item['å·²å¯¦ç¾æç›Š']);
                    if (pnl > 0) {
                        profitAmount += pnl;
                    } else if (pnl < 0) {
                        lossAmount += Math.abs(pnl); // å–çµ•å°å€¼
                    }
                });

                // 6. æº–å‚™åœ“é¤…åœ–è³‡æ–™ (ç›ˆåˆ© vs è™§æ)
                const labels = ['ç›ˆåˆ©', 'è™§æ'];
                const amounts = [profitAmount, lossAmount];
                const colors = ['var(--success-color)', 'var(--danger-color)'];

                // 7. ç¹ªè£½åœ“é¤…åœ–
                const ctx = document.getElementById('pnlPieChart').getContext('2d');

                if (charts['pnlPie']) {
                    charts['pnlPie'].destroy();
                }

                charts['pnlPie'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: amounts,
                            backgroundColor: ['#33FF57', '#FF5733'], // è¢å…‰ç¶ ã€é®®ç´…
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 16
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                titleFont: {
                                    size: 18
                                },
                                bodyFont: {
                                    size: 18
                                },
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw;
                                        const total = profitAmount + lossAmount;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                        label += `$${value.toLocaleString()} (${percentage})`;
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 16
                                },
                                formatter: function (value, context) {
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const total = profitAmount + lossAmount;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    return label + '\n' + percentage;
                                },
                                textAlign: 'center'
                            }
                        }
                    }
                });

                // 8. ç¹ªè£½æ˜ç´°è¡¨æ ¼ï¼ˆæŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
                const sortedData = allData.sort((a, b) => {
                    const dateA = String(a['æ—¥æœŸ'] || '');
                    const dateB = String(b['æ—¥æœŸ'] || '');
                    return dateB.localeCompare(dateA); // é™åºæ’åˆ—
                });
                renderPnLTable(sortedData);
            }

            // æ¸²æŸ“å·²å¯¦ç¾æç›Šæ˜ç´°è¡¨æ ¼
            function renderPnLTable(data) {
                const container = document.getElementById('pnlTableContainer');

                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">æ—¥æœŸ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">å¸‚å ´</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨ä»£è™Ÿ</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">è‚¡ç¥¨åç¨±</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">è³£å‡ºè‚¡æ•¸</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ç¸½æˆæœ¬</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">è³£å‡ºç¸½åƒ¹</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å·²å¯¦ç¾æç›Š</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">å ±é…¬ç‡%</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach((item, index) => {
                    const bgColor = index % 2 === 0 ? '#f9f9f9' : '#fff';
                    const pnl = parseMoney(item['å·²å¯¦ç¾æç›Š']);
                    const pnlColor = pnl >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                    const returnRate = parseMoney(item['å ±é…¬ç‡%']);
                    const returnColor = returnRate >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

                    tableHTML += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 10px; border: 1px solid #ddd;">${item['æ—¥æœŸ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item['å¸‚å ´'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item['è‚¡ç¥¨ä»£è™Ÿ'] || '-'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item['è‚¡ç¥¨åç¨±'] || '-'}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${parseMoney(item['è³£å‡ºè‚¡æ•¸']).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">$${parseMoney(item['ç¸½æˆæœ¬']).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">$${parseMoney(item['è³£å‡ºåƒ¹']).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${pnlColor}; font-weight: 600;">
                                ${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString()}
                            </td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: ${returnColor}; font-weight: 600;">
                                ${returnRate >= 0 ? '+' : ''}${returnRate.toFixed(2)}%
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;
            }

            // åˆ†é åˆ‡æ›é‚è¼¯
            function openTab(tabName) {
                // éš±è—æ‰€æœ‰ tab-content
                const contents = document.getElementsByClassName("tab-content");
                for (let i = 0; i < contents.length; i++) {
                    contents[i].classList.remove("active");
                }

                // ç§»é™¤æ‰€æœ‰ tab-btn çš„ active æ¨£å¼
                const buttons = document.getElementsByClassName("tab-btn");
                for (let i = 0; i < buttons.length; i++) {
                    buttons[i].classList.remove("active");
                }

                // é¡¯ç¤ºç•¶å‰ tab-content ä¸¦å°‡æŒ‰éˆ•è¨­ç‚º active
                document.getElementById(tabName).classList.add("active");

                // æ‰¾å‡ºé»æ“Šçš„æŒ‰éˆ•ä¸¦è¨­ç‚º active
                const buttonsArray = Array.from(buttons);
                const clickedBtn = buttonsArray.find(btn => btn.getAttribute('onclick').includes(tabName));
                if (clickedBtn) clickedBtn.classList.add("active");
            }
        </script>
</body>

</html>